<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/shell.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/libc.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">ELF文件格式</a><ul><li><a href="#h2-1">ELF中各个段概览</a><ul><li><a href="#h3-2">代码段</a></li></ul><ul><li><a href="#h3-3">数据段和只读数据段</a></li></ul><ul><li><a href="#h3-4">BSS段</a></li></ul><ul><li><a href="#h3-5">自定义段</a></li></ul></li></ul><ul><li><a href="#h2-6">其他说明</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">ELF文件格式</h1><blockquote><p>代码见 note/SimpleSection.c</p></blockquote><pre class="language-c"><code><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">printf</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token QualifyType CONST">const</span><span class="Keyword Token QualifyType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">format</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token VARARGS">...</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_init_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">84</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_uninit_var</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">func1</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">i</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">printf</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Format Token String STRING">%d</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PPtoken Token COMMA">,</span><span class="Identifier Token ID">i</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType VOID">void</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">85</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var2</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">a</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">b</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">func1</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Identifier Token ID">static_var</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">static_var2</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">a</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">b</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><p>使用 gcc 编译器得到 .o 文件</p><pre class="language-shell"><code><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token OPTION">-c</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.c</span></code></pre><h2 id="h2-1">ELF中各个段概览</h2><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">SimpleSection.o:</span><span class="Token SPACE">     </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Sections:</span><span class="Token LF">
</span><span class="Token Program ID">Idx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE">      </span><span class="Token ID">VMA</span><span class="Token SPACE">               </span><span class="Token ID">LMA</span><span class="Token SPACE">               </span><span class="Token ID">File</span><span class="Token SPACE"> </span><span class="Token ID">off</span><span class="Token SPACE">  </span><span class="Token ID">Algn</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">.text</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000064</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">RELOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">CODE</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000008</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">a4</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">2</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token Program ID">.bss</span><span class="Token SPACE">          </span><span class="Token NUMBER">00000008</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">ac</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">2</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">ALLOC</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token Program ID">.rodata</span><span class="Token SPACE">       </span><span class="Token NUMBER">00000004</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">ac</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">.comment</span><span class="Token SPACE">      </span><span class="Token NUMBER">0000002e</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">b0</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">5</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.GNU-stack</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">de</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">6</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.gnu.property</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000e0</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">7</span><span class="Token SPACE"> </span><span class="Token Program ID">.eh_frame</span><span class="Token SPACE">     </span><span class="Token NUMBER">00000058</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000100</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">RELOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span></code></pre><p>其中</p><ul><li><code>.text</code>: 程序源码编译后的机器指令</li></ul><ul><li><code>.data</code>: 数据段<p>初始化不为 0 的全局变量 + 初始化不为 0 的局部静态变量</p></li></ul><ul><li><code>.bss</code>: 另一个数据段<p>没有初始化的全局变量 + 初始化为 0 的全局变量 + 没有初始化的局部静态变量 + 初始化为 0 的局部静态变量</p><blockquote><p>没有初始化的默认值为 0, 和初始化为 0 效果相同</p></blockquote><p>单独分出来 .bss 段是因为 .data 段中需要为一个已经初始化的变量分配空间用于存放初始化的值, 如果初始值是 0 那么其实就没有必要分配. 这些变量在程序运行时确实需要占据内存空间, 但是没有必要在在可执行程序中为它们分配空间. <b>.bss 段只是为初始 值0的变量预留一个位置</b></p></li></ul><ul><li><code>.rodata</code>: 只读数据段</li></ul><ul><li><code>.comment</code>: 注释信息段<p>.comment 段是一种特殊的段,用于保存目标文件的注释信息.具体来说,它包含了编译器和汇编器使用的注释信息,例如编译器版本、编译选项、时间戳和作者等.</p><p>.comment 段的主要作用是为了方便开发者在需要时查看目标文件的注释信息,以便了解目标文件的编译环境和作者等相关信息.该段的大小通常很小,对程序的执行没有影响,因为它只是用于存储元数据.</p><p>在实际开发中,.comment 段的信息可以用于调试、版本控制和审计等方面.例如,如果您在调试时遇到了问题,您可以查看目标文件的注释信息,以确定该文件是由哪个编译器和版本生成的.同样,如果您需要对软件进行审计,您可以查看 .comment 段的信息,以确保该软件是由可信的开发者编写的,并且没有被修改或篡改过.在某些情况下如果希望禁用 .comment 段,以减小目标文件的大小或隐藏一些编译器和版本信息.您可以使用编译器选项 <code>-fno-ident</code></p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503195503.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503195503.png" alt="20230503195503"></a></p><p>可以使用如下指令查看 .comment 段的内容</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token OPTION">--section</span><span class="Token ASSIGN">=</span><span class="Token ID">.comment</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">SimpleSection.o:</span><span class="Token SPACE">     </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Contents</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token ID">.comment:</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000</span><span class="Token SPACE"> </span><span class="Token NUMBER">00474343</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="Token Program ID">a202855</span><span class="Token SPACE"> </span><span class="Token NUMBER">62756e74</span><span class="Token SPACE"> </span><span class="Token NUMBER">75203131</span><span class="Token SPACE">  </span><span class="Token Function ID">.GCC:</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">Ubuntu</span><span class="Token SPACE"> </span><span class="Token NUMBER">11</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token NUMBER">0010</span><span class="Token SPACE"> </span><span class="Token NUMBER">2e332</span><span class="Token Program ID">e30</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token ID">d317562</span><span class="Token SPACE"> </span><span class="Token NUMBER">756e7475</span><span class="Token SPACE"> </span><span class="Token NUMBER">317e3232</span><span class="Token SPACE">  </span><span class="Token ID">.3.0-1ubuntu1~22</span><span class="Token LF">
</span><span class="Token SPACE"> </span><span class="Token NUMBER">0020</span><span class="Token SPACE"> </span><span class="Token NUMBER">2e30342</span><span class="Token Program ID">e</span><span class="Token SPACE"> </span><span class="Token NUMBER">31292031</span><span class="Token SPACE"> </span><span class="Token NUMBER">312e332</span><span class="Token ID">e</span><span class="Token SPACE"> </span><span class="Token NUMBER">3000</span><span class="Token SPACE">      </span><span class="Token ID">.04.1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token NUMBER">11.3</span><span class="Token ID">.0.</span></code></pre></li></ul><ul><li><code>.note.GNU-stack</code>: 堆栈提示段</li></ul><p><b>区分不同段的作用主要是为了将指令和数据的存放区分开, 这样的好处主要有如下三点</b>:</p><ol start="1"><li>易于设置读写权限: 指令区域只读, 代码区域可读写,防止程序指令被有意/无意改写</li></ol><ol start="2"><li>现代CPU的缓存属性: 有益于程序的局部性</li></ol><ol start="3"><li>多副本可共享</li></ol><p>使用 size 查看一个 ELF 文件的代码段/数据段/BSS段的长度</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">size</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token Program ID">text</span><span class="Token SPACE">    </span><span class="Token ID">data</span><span class="Token SPACE">     </span><span class="Token ID">bss</span><span class="Token SPACE">     </span><span class="Token ID">dec</span><span class="Token SPACE">     </span><span class="Token ID">hex</span><span class="Token SPACE"> </span><span class="Token ID">filename</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">224</span><span class="Token SPACE">       </span><span class="Token NUMBER">8</span><span class="Token SPACE">       </span><span class="Token NUMBER">8</span><span class="Token SPACE">     </span><span class="Token NUMBER">240</span><span class="Token SPACE">      </span><span class="Token Program ID">f0</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span></code></pre><blockquote><p>这里的大小不是.o文件的大小, 只是段的大小, 可以使用 <code>du -b SimpleSection.o</code> 查看总大小(1936b)</p></blockquote><p>其中 224 是 <code>.text</code> + <code>.rodata</code> + <code>.note.GNU-stack</code> + <code>.note.gnu.property</code> + <code>.eh_frame</code> = 0xe0 = 224</p><h3 id="h3-2">代码段</h3><pre class="language-shell"><code><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span></code></pre><p>可以看到 .text 段的内容对应</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503221149.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503221149.png" alt="20230503221149"></a></p><h3 id="h3-3">数据段和只读数据段</h3><p>.data 段中保存的是 <code>int global_init_var = 84</code>(0x54), <code>static int static_var = 85</code>(0x55)</p><p>.rodata 段保存的是程序中的字符串常量 &quot;%d\n&quot;, 其 ASCII 值分别为 0x25 0x64 0x0a 0x00</p><blockquote><p>均采用小端存储</p></blockquote><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503220741.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503220741.png" alt="20230503220741"></a></p><h3 id="h3-4">BSS段</h3><pre class="language-shell"><code><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-x</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token OPTION">-d</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span></code></pre><p>可以在符号表中看到 <code>static_var2</code> 和 <code>global_uninit_var</code> 都保存在了 .bss 段中, .bss 段的大小是 8 字节</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503231927.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503231927.png" alt="20230503231927"></a></p><p>笔者在另一台机器中尝试: gcc version 10.2.1 20210110 (Debian 10.2.1-6), 得到的符号表如下所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503232709.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230503232709.png" alt="20230503232709"></a></p><p>此时如果我们稍微修改一下程序, 添加一个初始化为0的全局变量和一个初始化为0的静态局部变量</p><pre class="language-c"><code><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">printf</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token QualifyType CONST">const</span><span class="Keyword Token QualifyType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">format</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token VARARGS">...</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_init_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">84</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_zero_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_uninit_var</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">func1</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">i</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">printf</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Format Token String STRING">%d</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PPtoken Token COMMA">,</span><span class="Identifier Token ID">i</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType VOID">void</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">85</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_zero_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var2</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">a</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">b</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">func1</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Identifier Token ID">static_var</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">static_var2</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">a</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">b</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><p>再次编译查看 SYMBOL TABLE, 不难发现其中 static_zero_var 和 global_zero_var 都被放在 .bss 段中</p><pre class="language-shell"><code><span class="Token Program ID">SYMBOL</span><span class="Token SPACE"> </span><span class="Token ID">TABLE:</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">    </span><span class="Token ID">df</span><span class="Token SPACE"> </span><span class="Token MUL">*</span><span class="Token ID">ABS</span><span class="Token MUL">*</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.c</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.text</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.data</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.bss</span><span class="Token SPACE">   </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.rodata</span><span class="Token SPACE">        </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.rodata</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">static_var.2</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000008</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token SPACE">   </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">static_var2.1</span><span class="Token LF">
</span><span class="Token NUMBER">000000000000000</span><span class="Token Program ID">c</span><span class="Token SPACE"> </span><span class="Token ID">l</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token SPACE">   </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">static_zero_var.0</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">global_init_var</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token SPACE">   </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">global_zero_var</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token SPACE">   </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">global_uninit_var</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">     </span><span class="Token ID">F</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000000000002</span><span class="Token ID">b</span><span class="Token SPACE"> </span><span class="Token ID">func1</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">         </span><span class="Token MUL">*</span><span class="Token Program ID">UND</span><span class="Token MUL">*</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">printf</span><span class="Token LF">
</span><span class="Token NUMBER">000000000000002</span><span class="Token Program ID">b</span><span class="Token SPACE"> </span><span class="Token ID">g</span><span class="Token SPACE">     </span><span class="Token ID">F</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000039</span><span class="Token SPACE"> </span><span class="Token ID">main</span></code></pre><p>还可以使用 <code>objcopy</code> 将一张图片添加到 .o 文件中</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objcopy</span><span class="Token SPACE"> </span><span class="Token OPTION">-I</span><span class="Token SPACE"> </span><span class="Token ID">binary</span><span class="Token SPACE"> </span><span class="Token OPTION">-O</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token SPACE"> </span><span class="Token ID">a.jpg</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-ht</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">SimpleSection.o:</span><span class="Token SPACE">     </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Sections:</span><span class="Token LF">
</span><span class="Token Program ID">Idx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE">      </span><span class="Token ID">VMA</span><span class="Token SPACE">               </span><span class="Token ID">LMA</span><span class="Token SPACE">               </span><span class="Token ID">File</span><span class="Token SPACE"> </span><span class="Token ID">off</span><span class="Token SPACE">  </span><span class="Token ID">Algn</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">         </span><span class="Token NUMBER">00009261</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token Program ID">SYMBOL</span><span class="Token SPACE"> </span><span class="Token ID">TABLE:</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">       </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">_binary_a_jpg_start</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000009261</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">       </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">_binary_a_jpg_end</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000009261</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">       </span><span class="Token MUL">*</span><span class="Token ID">ABS</span><span class="Token MUL">*</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">_binary_a_jpg_size</span></code></pre><p>其中 <code>_binary_a_jpg_start</code> <code>_binary_a_jpg_end</code> <code>_binary_a_jpg_size</code> 分别表示起始地址, 结束地址, 大小, <b>我们可以在程序中直接声明并使用它们</b>, 例如打印出图像数据的前10个字节:</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Preprocess ControlLine Keyword Token INCLUDE">include</span><span class="Preprocess ControlLine Keyword Token SPACE"> </span><span class="HeaderName ControlLine Token BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="HeaderName Token String STRING">stdio.h</span><span class="HeaderName ControlLine Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Keyword Token StorageType EXTERN">extern</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">_binary_a_jpg_start</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Keyword Token StorageType EXTERN">extern</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">_binary_a_jpg_end</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Keyword Token StorageType EXTERN">extern</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">_binary_a_jpg_size</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Keyword Token IterationStatement FOR">for</span><span class="Keyword Token IterationStatement SPACE"> </span><span class="BraceDepth-1 Token IterationStatement LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">i</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">0</span><span class="Token IterationStatement Declaration SEMI">;</span><span class="Token IterationStatement Declaration SPACE"> </span><span class="Identifier Token PrimaryExpression ID">i</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">10</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Identifier Token PrimaryExpression ID">i</span><span class="Token UnaryExpression PostfixExpression INC">++</span><span class="BraceDepth-1 Token IterationStatement RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="CompoundStatement Token IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="CompoundStatement Token IterationStatement LF">
</span><span class="CompoundStatement Token IterationStatement SPACE">        </span><span class="Identifier Token PrimaryExpression FunctionCall ID">printf</span><span class="BraceDepth-2 Token UnaryExpression PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Format Token String STRING">%02x</span><span class="Token String STRING"> &quot;</span><span class="Token UnaryExpression PostfixExpression COMMA">,</span><span class="Token UnaryExpression PostfixExpression SPACE"> </span><span class="Identifier Token PrimaryExpression ID">_binary_a_jpg_start</span><span class="BraceDepth-0 Token UnaryExpression PostfixExpression LSQUAR_PAREN">[</span><span class="Identifier Token PrimaryExpression ID">i</span><span class="BraceDepth-0 Token UnaryExpression PostfixExpression RSQUAR_PAREN">]</span><span class="BraceDepth-2 Token UnaryExpression PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="CompoundStatement Token IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="CompoundStatement Token IterationStatement LF">
</span><span class="CompoundStatement Token IterationStatement SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionCall ID">printf</span><span class="BraceDepth-1 Token UnaryExpression PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="BraceDepth-1 Token UnaryExpression PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><blockquote><p>这种将图片直接打入目标文件是一种方式,不过会导致文件变大</p></blockquote><h3 id="h3-5">自定义段</h3><pre class="language-c"><code>int printf(const char *format, ...);

int global_init_var = 84;
int global_uninit_var;

__attribute__((section(&quot;FOO&quot;))) int global_foo_var = 42;

__attribute__((section(&quot;BAR&quot;))) void foo() {
    
}

void func1(int i) {
    printf(&quot;%d\n&quot;,i);
}

int main(void) {
    static int static_var = 85;
    static int static_var2;
    int a = 1;
    int b;
    func1(static_var + static_var2 + a + b);
}</code></pre><p>可以看到新增了两个段</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230504002317.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230504002317.png" alt="20230504002317"></a></p><p><code>__attribute__((section(&quot;name&quot;)))</code> 是GCC和Clang编译器的扩展,它不是C标准的一部分,因此不是所有的编译器都支持它.在MSVC编译器中,可以使用#pragma section指令来将变量或函数放置在自定义段中(#pragma section指令是MSVC编译器的扩展).例如:</p><pre class="language-c"><code>#pragma section(&quot;FOO&quot;, read, write)
int global_foo_var = 42;

#pragma section(&quot;BAR&quot;, execute)
void foo() {
    // ...
}</code></pre><h2 id="h2-6">其他说明</h2><p>当然 GCC 编译器提供了关于 ELF 的众多选项</p><p><code>-fdata-sections</code> 和 <code>-ffunction-sections</code> 是GCC编译器的选项,用于将数据和函数放置在单独的段中.</p><p>当使用这些选项时,<b>GCC会将每个全局变量和函数放置在单独的段中,而不是将它们放置在默认的.data和.text段中</b>.这样做的好处是可以将不同的数据和函数放置在不同的段中,从而使得目标文件更加灵活.例如,您可以将只读数据放置在只读段中,将可写数据放置在可写段中,将可执行代码放置在可执行段中.</p><pre class="language-shell"><code><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token OPTION">-c</span><span class="Token SPACE"> </span><span class="Token OPTION">-fdata-sections</span><span class="Token SPACE"> </span><span class="Token OPTION">-ffunction-sections</span><span class="Token SPACE"> </span><span class="Token ID">file.c</span></code></pre><p>在将目标文件链接到可执行文件时,您需要使用 <code>-Wl</code> , <code>--gc-sections</code> 选项来删除未使用的段.这将从目标文件中删除未使用的段,从而减少可执行文件的大小.例如:</p><pre class="language-shell"><code><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token OPTION">-Wl</span><span class="Token COMMA">,</span><span class="Token OPTION">--gc-sections</span><span class="Token SPACE"> </span><span class="Token ID">file.o</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">program</span></code></pre><p>请注意,使用 <code>-fdata-sections</code> 和 <code>-ffunction-sections</code> 选项可能会增加目标文件的大小,并在链接时增加一些开销.然而,通过将数据和函数放置在单独的段中,可以使得目标文件更加灵活,并且可以优化可执行文件的大小和性能.</p><p>比如我们稍微修改一下代码</p><pre class="language-c"><code><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">printf</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token QualifyType CONST">const</span><span class="Keyword Token QualifyType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">format</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token VARARGS">...</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_init_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">84</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_init_var2</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">88</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_uninit_var</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">func1</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">i</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">printf</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Format Token String STRING">%d</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PPtoken Token COMMA">,</span><span class="Identifier Token ID">i</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType VOID">void</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">85</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var2</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">89</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var3</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">a</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">b</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">func1</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Identifier Token ID">static_var</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">static_var2</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">a</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">b</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><p>不难发现 ELF 中 .text .data 已经分开了</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230504003246.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230504003246.png" alt="20230504003246"></a></p></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../linux/目录" >linux</a><ul><li><a href="../../linux/目录" >目录</a></li></ul><ul><li><a href="../../linux/终端" >终端</a></li></ul></li></ul><ul><li><a href="../../libc/LD_PRELOAD" >libc</a><ul><li><a href="../../libc/LD_PRELOAD" >LD_PRELOAD</a></li></ul></li></ul><ul><li><a href="../../工具库/命令行参数解析" >工具库</a><ul><li><a href="../../工具库/命令行参数解析" >命令行参数解析</a></li></ul></li></ul><ul><li><a href="../../miniCRT/ELF文件格式" >miniCRT</a><ul><li><a href="../../miniCRT/ELF文件格式" >ELF文件格式</a></li></ul><ul><li><a href="../../miniCRT/ELF文件结构详解" >ELF文件结构详解</a></li></ul><ul><li><a href="../../miniCRT/符号表" >符号表</a></li></ul><ul><li><a href="../../miniCRT/静态链接" >静态链接</a></li></ul></li></ul><ul><li><a href="../../阅读资料/起始地址故事" >阅读资料</a><ul><li><a href="../../阅读资料/起始地址故事" >起始地址故事</a></li></ul><ul><li><a href="../../阅读资料/编译器与C++" >编译器与C++</a></li></ul><ul><li><a href="../../阅读资料/交叉编译" >交叉编译</a></li></ul><ul><li><a href="../../阅读资料/AUB" >AUB</a></li></ul><ul><li><a href="../../阅读资料/gettext" >gettext</a></li></ul><ul><li><a href="../../阅读资料/gcc参数" >gcc参数</a></li></ul><ul><li><a href="../../阅读资料/函数命名规则" >函数命名规则</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../工具库/命令行参数解析","../../miniCRT/ELF文件结构详解","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>