<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/shell.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/libc.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">符号表</a><ul><li><a href="#h2-1">符号值</a></li></ul><ul><li><a href="#h2-2">特殊符号</a></li></ul><ul><li><a href="#h2-3">符号修饰和函数签名</a><ul><li><a href="#h3-4">C++符号修饰</a></li></ul><ul><li><a href="#h3-5">extern "C"</a></li></ul><ul><li><a href="#h3-6">强符号和弱符号</a></li></ul><ul><li><a href="#h3-7">强引用和弱引用</a></li></ul></li></ul><ul><li><a href="#h2-8">调试信息</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">符号表</h1><p>链接过程的本质就是要把多个不同的目标文件之间相互粘到一起, 当然这些目标文件之间必须有固定的规则. 在链接中, 目标文件之间相互拼合实际上是目标文件之间对地址的引用, 即对函数和变量的地址的引用</p><p>比如目标文件 B 要用到目标文件 A 中的函数 <code>foo</code>, 那么我们就称目标文件 A <b>定义(define)</b> 了函数 foo, 目标文件 B <b>引用(reference)</b> 了目标文件 A 中的函数 foo, 这两个概念也同样适用于变量</p><p>每一个函数或变量都有自己独特的名字, 才能避免链接过程中不同变量和函数之间的混淆. 在链接中, 我们将函数和变量统称为<b>符号(Symbol)</b>, 函数名或变量名 称为 <b>符号名(symbol name)</b>. 每一个目标文件都会有一个相应的<b>符号表(symbol table)</b>, 每一个定义的符号都有一个对应的值叫做<b>符号值(symbol value)</b>. 对于变量和函数来说, 符号值就是它们的地址</p><blockquote><p>这里需要注意的是符号值实际上是符号的地址, 并不是a=1这种实际的变量值. 除了函数和变量之外还存在几种不常用的符号, 会在后文介绍</p></blockquote><p>对于符号表中的符号, 它们一定是下面的类型之一:</p><ol start="1"><li>定义在本目标文件的全局符号, 可以被其他目标文件引用, 例如 <code>func1</code>, <code>main</code> <code>global_init_var</code></li></ol><ol start="2"><li>在本目标文件中引用的全局符号, 却没有定义在本目标文件中, 这种一般叫做<b>外部符号(extern symbol)</b>, 比如 <code>printf</code></li></ol><ol start="3"><li>段名, 这种符号由编译器产生, 符号值就是该段的起始地址, 比如 <code>.text</code> <code>.data</code></li></ol><ol start="4"><li>局部符号, 这里的局部符号指局部静态变量, 也就是 <code>static_var</code> <code>static_var2</code>, 局部非静态变量比如 a, b 是不会进入符号表中的, 它们会在栈中分配内存空间. 局部符号只在编译单元内部可见, 也就是说被 static 修饰的变量或函数只在当前文件可以被使用, 其他文件无法使用. 调试器可以使用这些符号来分析, 但链接器会忽略这些局部符号</li></ol><ol start="5"><li>行号信息, 即目标文件指令与源代码行的对应关系</li></ol><pre class="language-c"><code><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">printf</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token QualifyType CONST">const</span><span class="Keyword Token QualifyType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">format</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token VARARGS">...</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_init_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">84</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_uninit_var</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">func1</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">i</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">printf</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Format Token String STRING">%d</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PPtoken Token COMMA">,</span><span class="Identifier Token ID">i</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType VOID">void</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">85</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var2</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">a</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">b</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">func1</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Identifier Token ID">static_var</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">static_var2</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">a</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">b</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><p>对于我们来说最值得关注的就是全局符号, 也就是1和2. 因为链接的过程只关心全局符号的相互粘合, 局部符号,段名行号都是次要的, 它们对于其他目标文件来说都是不可见的, 在链接过程中也是无关紧要的</p><p>我们可以使用很多工具来查看一个 ELF 文件的符号表</p><pre class="language-shell"><code><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-t</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token Program ID">readelf</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Token Program ID">nm</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span></code></pre><pre class="language-shell"><code><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">T</span><span class="Token SPACE"> </span><span class="Token ID">func1</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">D</span><span class="Token SPACE"> </span><span class="Token ID">global_init_var</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">B</span><span class="Token SPACE"> </span><span class="Token ID">global_uninit_var</span><span class="Token LF">
</span><span class="Token NUMBER">000000000000002</span><span class="Token Program ID">b</span><span class="Token SPACE"> </span><span class="Token ID">T</span><span class="Token SPACE"> </span><span class="Token ID">main</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token ID">printf</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token Program ID">d</span><span class="Token SPACE"> </span><span class="Token ID">static_var.1</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token Program ID">b</span><span class="Token SPACE"> </span><span class="Token ID">static_var2.0</span></code></pre><table><tr><th>符号字母</th><th>含义</th></tr><tr><td style="text-align:left">                T</td><td style="text-align:left">                代码符号,表示该符号是一个函数或者可执行代码.</td></tr><tr><td style="text-align:left">                t</td><td style="text-align:left">                本地代码符号,表示该符号是本地的函数或代码,仅在当前目标文件中可见.</td></tr><tr><td style="text-align:left">                D</td><td style="text-align:left">                数据符号,表示该符号是一个初始化的全局变量或静态变量.</td></tr><tr><td style="text-align:left">                d</td><td style="text-align:left">                本地数据符号,表示该符号是本地的已初始化数据,仅在当前目标文件中可见.</td></tr><tr><td style="text-align:left">                B</td><td style="text-align:left">                BSS符号,表示该符号是一个未初始化的全局变量或静态变量.</td></tr><tr><td style="text-align:left">                b</td><td style="text-align:left">                本地BSS符号,表示该符号是本地的未初始化数据,仅在当前目标文件中可见.</td></tr><tr><td style="text-align:left">                U</td><td style="text-align:left">                未定义符号,表示该符号在当前目标文件中未定义,需要在链接时从其它目标文件或库文件中解析.</td></tr><tr><td style="text-align:left">                R</td><td style="text-align:left">                重定位符号,表示该符号需要在链接时进行重定位.</td></tr><tr><td style="text-align:left">                r</td><td style="text-align:left">                本地重定位符号,表示该符号是本地的需要进行重定位的符号,仅在当前目标文件中可见.</td></tr><tr><td style="text-align:left">                C</td><td style="text-align:left">                弱符号,表示该符号是一个弱符号,其定义可以被覆盖.</td></tr><tr><td style="text-align:left">                W</td><td style="text-align:left">                弱符号,表示该符号是一个弱符号,其引用可以不被解析,或者可以被重复解析.</td></tr><tr><td style="text-align:left">                S</td><td style="text-align:left">                特殊符号,表示该符号是一个特殊符号(例如,汇编代码中的符号).</td></tr><tr><td style="text-align:left">                V</td><td style="text-align:left">                可变符号,表示该符号是一个可变符号(例如,C++虚函数).</td></tr><tr><td style="text-align:left">                I</td><td style="text-align:left">                间接符号,表示该符号是一个间接符号,需要进一步解析.</td></tr></table><p>ELF 文件中可能会出现多个符号表, 可以先搜索段表中的每一个段, 判断 <code>((shdr-&gt;sh_type == SHT_SYMTAB) || (shdr-&gt;sh_type == SHT_DYNSYM))</code> 两种情况, 如果符合则说明是一个符号表</p><blockquote><p>这里的 SHT_SYMTAB 对应静态符号表, SHT_DYNSYM 对应动态符号表</p></blockquote><p><b>对于符号表来说, shdr-&gt;sh_link 代表其使用的字符串段</b>, 比如使用 <code>readelf -S</code> 查看一个可执行文件, 其中 .symtab 的 link 指向 .strtab, .dynsym 的 link 指向 .dynstr</p><pre class="language-shell"><code><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Program ID">Nr</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">              </span><span class="Token ID">Type</span><span class="Token SPACE">             </span><span class="Token ID">Address</span><span class="Token SPACE">           </span><span class="Token ID">Offset</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token Program ID">Size</span><span class="Token SPACE">              </span><span class="Token ID">EntSize</span><span class="Token SPACE">          </span><span class="Token ID">Flags</span><span class="Token SPACE">  </span><span class="Token ID">Link</span><span class="Token SPACE">  </span><span class="Token ID">Info</span><span class="Token SPACE">  </span><span class="Token ID">Align</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">6</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.dynsym</span><span class="Token SPACE">           </span><span class="Token ID">DYNSYM</span><span class="Token SPACE">           </span><span class="Token NUMBER">00000000000003</span><span class="Token ID">d8</span><span class="Token SPACE">  </span><span class="Token NUMBER">000003</span><span class="Token ID">d8</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">00000000000002e8</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Token Program ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">7</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">7</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.dynstr</span><span class="Token SPACE">           </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">00000000000006</span><span class="Token ID">c0</span><span class="Token SPACE">  </span><span class="Token NUMBER">000006</span><span class="Token ID">c0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">000000000000014</span><span class="Token Program ID">a</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token Program ID">...</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">28</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.symtab</span><span class="Token SPACE">           </span><span class="Token ID">SYMTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00008040</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">00000000000008</span><span class="Token Program ID">d0</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">          </span><span class="Token NUMBER">29</span><span class="Token SPACE">    </span><span class="Token NUMBER">25</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">29</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.strtab</span><span class="Token SPACE">           </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00008910</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">00000000000005</span><span class="Token Program ID">bc</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span></code></pre><p>在段表中搜索到字符表段之后就可以借助其 offset 定位到这个段了. 字符表段是一个长度为 n 的数组, 数组中的每一个元素都是 <code>Elf64_Sym</code>, 用于表示一个符号, 其结构体如下所示</p><pre class="language-c"><code><span class="Keyword Token StorageType TYPEDEF">typedef</span><span class="Keyword Token StorageType SPACE"> </span><span class="Structure Token StructureType Keyword TypeSpecifier STRUCT">struct</span><span class="Structure Token StructureType Keyword TypeSpecifier SPACE"> </span><span class="Structure Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Structure Token LF">
</span><span class="Structure Token SPACE">   </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint32_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">st_name</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token SPACE">   </span><span class="StructDeclaration Token COMMENT">// 符号名</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">   </span><span class="Keyword Token TypeSpecifier BaseType UNSIGNED">unsigned</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">st_info</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token SPACE">   </span><span class="StructDeclaration Token COMMENT">// 符号类型和绑定信息</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">   </span><span class="Keyword Token TypeSpecifier BaseType UNSIGNED">unsigned</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">st_other</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token SPACE">  </span><span class="StructDeclaration Token COMMENT">// 暂未使用</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">   </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint16_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">st_shndx</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token SPACE">  </span><span class="StructDeclaration Token COMMENT">// 符号所在的段</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">   </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">Elf64_Addr</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">    </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">st_value</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token SPACE">  </span><span class="StructDeclaration Token COMMENT">// 符号值</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">   </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint64_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">st_size</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token SPACE">   </span><span class="StructDeclaration Token COMMENT">// 符号大小</span><span class="StructDeclaration Token LF">
</span><span class="Structure Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Structure Token SPACE"> </span><span class="Identifier DirectDeclaractor Token Typedefine ID">Elf64_Sym</span><span class="Token Declaration SEMI">;</span></code></pre><p>因此可以利用段表中的 <code>sh_size / sizeof(Elf64_Sym)</code> 计算得到 n, 依次遍历每一个符号即可</p><p>需要注意的是, 对于一般的符号来说直接在 <code>.strtab + 偏移量</code> 就可以找到符号名, 但是使用 <code>readelf -s SimpleSection.o</code> 查看会得到如下结果.</p><pre class="language-shell"><code><span class="Token Program ID">Symbol</span><span class="Token SPACE"> </span><span class="Token ID">table</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.symtab</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">13</span><span class="Token SPACE"> </span><span class="Token ID">entries:</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token Program ID">Num:</span><span class="Token SPACE">    </span><span class="Token ID">Value</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">Type</span><span class="Token SPACE">    </span><span class="Token ID">Bind</span><span class="Token SPACE">   </span><span class="Token ID">Vis</span><span class="Token SPACE">      </span><span class="Token ID">Ndx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">FILE</span><span class="Token SPACE">    </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">ABS</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.c</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">3</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token ID">.data</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">5</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">5</span><span class="Token SPACE"> </span><span class="Token ID">.rodata</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">6</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token ID">static_var.1</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">7</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token ID">static_var2.0</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token ID">global_init_var</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">9</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token ID">global_uninit_var</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">10</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">    </span><span class="Token NUMBER">43</span><span class="Token SPACE"> </span><span class="Token Program ID">FUNC</span><span class="Token SPACE">    </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">func1</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">11</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">printf</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">12</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">000000000000002</span><span class="Token Program ID">b</span><span class="Token SPACE">    </span><span class="Token NUMBER">57</span><span class="Token SPACE"> </span><span class="Token ID">FUNC</span><span class="Token SPACE">    </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">main</span></code></pre><p><b>注意这里的 2/3/4/5 号符号的属性是 SECTION 代表这是一个段, 这里的对应的字符串并不是保存在 <code>.strtab</code> 中的, 需要使用 st_shndx 作为索引值在段表中查询对应段的名字, 也就是说在 <code>.shstrtab</code> 中才可以找到符号的名字</b>, 对应的代码实现如下所示. 您可以在 <a href="https://github.com/luzhixing12345/miniCRT/blob/main/binutils/readelf.c" target="_blank">readelf.c</a> 中查看完整代码</p><pre class="language-c"><code><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">symbol_name</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration COMMENT">// 对于 st_name 的值不为0的符号或者 ABS, 去对应的 .strtab 中找</span><span class="Token Declaration LF">
</span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="Token BraceDepth-0 SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">symtabs</span><span class="BraceDepth-1 Token UnaryExpression PostfixExpression LSQUAR_PAREN">[</span><span class="Identifier Token PrimaryExpression ID">j</span><span class="BraceDepth-1 Token UnaryExpression PostfixExpression RSQUAR_PAREN">]</span><span class="Token UnaryExpression PostfixExpression DOT">.</span><span class="Identifier Token ID">st_name</span><span class="Identifier Token SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Identifier Token PrimaryExpression ID">symtabs</span><span class="BraceDepth-1 Token UnaryExpression PostfixExpression LSQUAR_PAREN">[</span><span class="Identifier Token PrimaryExpression ID">j</span><span class="BraceDepth-1 Token UnaryExpression PostfixExpression RSQUAR_PAREN">]</span><span class="Token UnaryExpression PostfixExpression DOT">.</span><span class="Identifier Token ID">st_shndx</span><span class="Identifier Token SPACE"> </span><span class="Token BinaryOp EQ">==</span><span class="Token BinaryOp SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">SHN_ABS</span><span class="Token BraceDepth-0 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">  </span><span class="Identifier Token PrimaryExpression ID">symbol_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="BraceDepth-1 ConditionalExpression Token CastExpression LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="BraceDepth-1 ConditionalExpression Token CastExpression RPAREN">)</span><span class="BraceDepth-1 Token PrimaryExpression PostfixExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">ELF_file_data</span><span class="Token UnaryExpression PostfixExpression POINT">-&gt;</span><span class="Identifier Token ID">addr</span><span class="Identifier Token SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Identifier Token PrimaryExpression ID">strtab</span><span class="Token UnaryExpression PostfixExpression POINT">-&gt;</span><span class="Identifier Token ID">sh_offset</span><span class="Identifier Token SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Identifier Token PrimaryExpression ID">symtabs</span><span class="BraceDepth-2 Token UnaryExpression PostfixExpression LSQUAR_PAREN">[</span><span class="Identifier Token PrimaryExpression ID">j</span><span class="BraceDepth-2 Token UnaryExpression PostfixExpression RSQUAR_PAREN">]</span><span class="Token UnaryExpression PostfixExpression DOT">.</span><span class="Identifier Token ID">st_name</span><span class="BraceDepth-1 Token PrimaryExpression PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement SPACE"> </span><span class="Keyword Token SelectionStatement ELSE">else</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">  </span><span class="CompoundStatement Token SelectionStatement COMMENT">// 为 0 说明是一个特殊符号, 用 symbol_ndx 去段表字符串表中找</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">  </span><span class="Identifier Token PrimaryExpression ID">symbol_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="BraceDepth-1 ConditionalExpression Token CastExpression LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="BraceDepth-1 ConditionalExpression Token CastExpression RPAREN">)</span><span class="BraceDepth-1 Token PrimaryExpression PostfixExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">ELF_file_data</span><span class="Token UnaryExpression PostfixExpression POINT">-&gt;</span><span class="Identifier Token ID">addr</span><span class="Identifier Token SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Identifier Token PrimaryExpression ID">ELF_file_data</span><span class="Token UnaryExpression PostfixExpression POINT">-&gt;</span><span class="Identifier Token ID">shstrtab_offset</span><span class="Identifier Token SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">                         </span><span class="Identifier Token PrimaryExpression ID">ELF_file_data</span><span class="Token UnaryExpression PostfixExpression POINT">-&gt;</span><span class="Identifier Token ID">shdr</span><span class="BraceDepth-2 Token UnaryExpression PostfixExpression LSQUAR_PAREN">[</span><span class="Identifier Token PrimaryExpression ID">symtabs</span><span class="BraceDepth-0 Token UnaryExpression PostfixExpression LSQUAR_PAREN">[</span><span class="Identifier Token PrimaryExpression ID">j</span><span class="BraceDepth-0 Token UnaryExpression PostfixExpression RSQUAR_PAREN">]</span><span class="Token UnaryExpression PostfixExpression DOT">.</span><span class="Identifier Token ID">st_shndx</span><span class="BraceDepth-2 Token UnaryExpression PostfixExpression RSQUAR_PAREN">]</span><span class="Token UnaryExpression PostfixExpression DOT">.</span><span class="Identifier Token ID">sh_name</span><span class="BraceDepth-1 Token PrimaryExpression PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 SelectionStatement RCURLY_BRACE">}</span></code></pre><p>同时注意到有一列信息是 <code>Vis</code>, Vis 在 C/C++ 中未使用, 用于控制符号可见性, Rust/Swift 使用到了, 这里默认 DEFAULT 即可</p><blockquote><p>但是在可执行文件中确实存在 HIDDEN ?</p><p>.dynsym 中显示函数名而不是 [...]@GLIBC_2.2.5 (2) ?</p></blockquote><h2 id="h2-1">符号值</h2><p><b>需要注意的是默认情况下,未初始化的全局变量会被放置在 BSS 段中,而不是 .common 块中</b></p><p>要将变量放置在 .common 块中,需要使用 <code>__attribute__((common))</code> 属性或者编写链接器脚本来显式地指定.但是,这种方法并不常用,因为common 块是一种非标准的方式来管理未初始化的全局变量,不同的编译器和链接器可能会有不同的行为.</p><pre class="language-c"><code>int printf(const char *format, ...);

__attribute__((common)) int global_init_var;
__attribute__((common)) int global_uninit_var;

void func1(int i) {
    printf(&quot;%d\n&quot;,i);
}

int main(void) {
    static int static_var = 85;
    static int static_var2;
    int a = 1;
    int b;
    func1(static_var + static_var2 + a + b);
}</code></pre><p>这里我们还是以之前的 SimpleSection.o 为例</p><pre class="language-shell"><code><span class="Token Program ID">Symbol</span><span class="Token SPACE"> </span><span class="Token ID">table</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.symtab</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">13</span><span class="Token SPACE"> </span><span class="Token ID">entries:</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token Program ID">Num:</span><span class="Token SPACE">    </span><span class="Token ID">Value</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">Type</span><span class="Token SPACE">    </span><span class="Token ID">Bind</span><span class="Token SPACE">   </span><span class="Token ID">Vis</span><span class="Token SPACE">      </span><span class="Token ID">Ndx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">FILE</span><span class="Token SPACE">    </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">ABS</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.c</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">3</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token ID">.data</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">5</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">5</span><span class="Token SPACE"> </span><span class="Token ID">.rodata</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">6</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token ID">static_var.1</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">7</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token ID">static_var2.0</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token ID">global_init_var</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">9</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token ID">global_uninit_var</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">10</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">    </span><span class="Token NUMBER">43</span><span class="Token SPACE"> </span><span class="Token Program ID">FUNC</span><span class="Token SPACE">    </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">func1</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">11</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">printf</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">12</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">000000000000002</span><span class="Token Program ID">b</span><span class="Token SPACE">    </span><span class="Token NUMBER">57</span><span class="Token SPACE"> </span><span class="Token ID">FUNC</span><span class="Token SPACE">    </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">main</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">SYMBOL</span><span class="Token SPACE"> </span><span class="Token ID">TABLE:</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">    </span><span class="Token ID">df</span><span class="Token SPACE"> </span><span class="Token MUL">*</span><span class="Token ID">ABS</span><span class="Token MUL">*</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.c</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.text</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.data</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.bss</span><span class="Token SPACE">   </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.rodata</span><span class="Token SPACE">        </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.rodata</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">static_var.1</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token Program ID">l</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token SPACE">   </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">static_var2.0</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">global_init_var</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token SPACE">   </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">global_uninit_var</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">g</span><span class="Token SPACE">     </span><span class="Token ID">F</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000000000002</span><span class="Token ID">b</span><span class="Token SPACE"> </span><span class="Token ID">func1</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">         </span><span class="Token MUL">*</span><span class="Token Program ID">UND</span><span class="Token MUL">*</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">printf</span><span class="Token LF">
</span><span class="Token NUMBER">000000000000002</span><span class="Token Program ID">b</span><span class="Token SPACE"> </span><span class="Token ID">g</span><span class="Token SPACE">     </span><span class="Token ID">F</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000039</span><span class="Token SPACE"> </span><span class="Token ID">main</span></code></pre><p>对于符号值来说有以下几种情况</p><ol start="1"><li>符号不是 COMMON 类型, 符号值代表 <b>该符号在段中的偏移量</b><p>这种情况是最常见的情况, 例如对于 <code>func1</code>, 其位于1号段也就是 <code>.text</code> 段, 偏移量是 0. <code>static_var</code> 定义在 3 号 <code>.data</code> 偏移量是 0x4, 这个偏移量是因为在它前面还有一个 <code>global_init_var</code></p></li></ol><ol start="2"><li>如果是 COMMON 类型, 符号值代表对齐属性</li></ol><ol start="3"><li>可执行文件中, 符号值代表符号的虚拟地址, 这个虚拟地址对于动态链接器十分有用</li></ol><h2 id="h2-2">特殊符号</h2><p>当我们使用 ld 作为链接器来链接生产可执行文件的时候, 它会为我们定义很多特殊的符号. 这些符号并没有在你的程序中定义, 但是可以直接声明并且使用它们</p><blockquote><p>其实这些符号是被定义为 ld 链接器的脚本当中的, 在后文链接过程控制这一节会回顾这个问题</p></blockquote><pre class="language-c"><code><span class="Token HASH">#</span><span class="Preprocess ControlLine Keyword Token INCLUDE">include</span><span class="Preprocess ControlLine Keyword Token SPACE"> </span><span class="HeaderName ControlLine Token BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="HeaderName Token String STRING">stdio.h</span><span class="HeaderName ControlLine Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Keyword Token StorageType EXTERN">extern</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">__executable_start</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE"> </span><span class="Token Declaration COMMENT">// 程序的起始地址, 不是入口地址</span><span class="Token Declaration LF">
</span><span class="Keyword Token StorageType EXTERN">extern</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">etext</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">_etext</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">__etext</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE"> </span><span class="Token Declaration COMMENT">// 代码段的结束地址</span><span class="Token Declaration LF">
</span><span class="Keyword Token StorageType EXTERN">extern</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">edata</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">_edata</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE"> </span><span class="Token Declaration COMMENT">// 数据段的结束地址</span><span class="Token Declaration LF">
</span><span class="Keyword Token StorageType EXTERN">extern</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType CHAR">char</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">end</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">_end</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE"> </span><span class="Token Declaration COMMENT">// 程序结束地址</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">printf</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token String STRING">&quot;Execuatable Start </span><span class="Format Token String STRING">%p</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PPtoken Token COMMA">,</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">__executable_start</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">printf</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token String STRING">&quot;Text End </span><span class="Format Token String STRING">%p</span><span class="Token String STRING"> </span><span class="Format Token String STRING">%p</span><span class="Token String STRING"> </span><span class="Format Token String STRING">%p</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PPtoken Token COMMA">,</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">etext</span><span class="PPtoken Token COMMA">,</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">_etext</span><span class="PPtoken Token COMMA">,</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">__etext</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">printf</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token String STRING">&quot;Data End </span><span class="Format Token String STRING">%p</span><span class="Token String STRING"> </span><span class="Format Token String STRING">%p</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PPtoken Token COMMA">,</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">edata</span><span class="PPtoken Token COMMA">,</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">_edata</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">printf</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token String STRING">&quot;Execuatable End </span><span class="Format Token String STRING">%p</span><span class="Token String STRING"> </span><span class="Format Token String STRING">%p</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PPtoken Token COMMA">,</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">end</span><span class="PPtoken Token COMMA">,</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">_end</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><pre class="language-shell"><code><span class="Token Program ID">Execuatable</span><span class="Token SPACE"> </span><span class="Token ID">Start</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x5577aa444000</span><span class="Token LF">
</span><span class="Token Program ID">Text</span><span class="Token SPACE"> </span><span class="Token ID">End</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x5577aa445205</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x5577aa445205</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x5577aa445205</span><span class="Token LF">
</span><span class="Token Program ID">Data</span><span class="Token SPACE"> </span><span class="Token ID">End</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x5577aa448010</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x5577aa448010</span><span class="Token LF">
</span><span class="Token Program ID">Execuatable</span><span class="Token SPACE"> </span><span class="Token ID">End</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x5577aa448018</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x5577aa448018</span></code></pre><h2 id="h2-3">符号修饰和函数签名</h2><p>20 世纪 70 年代以前, 编译器编译源代码产生目标文件的时候符号名和相应的变量名和函数名是一样的. 后来 UNIX 平台和 C 语言发明之后, 存在了相当多使用汇编写的库和目标文件, 这样就产生了一个问题, 如果一个 C 程序想要使用这些库就不可以使用冲突的符号名. 同样, 如果 C 的目标文件要用到一个使用 Fortran 语言编写的目标文件, 也必须避免命名冲突</p><p>为了防止类似的符号名冲突, UNIX 下的 C 语言就规定源代码文件中的所有全局变量和函数经过编译之后, 相对应的符号名前加下划线, Fortran 编译之后前后都加下划线, 也就是如果一个函数 <code>foo</code>, C 编译之后就变成了 <code>_foo</code>, Fortran 就变成了 <code>_foo_</code></p><p>这种方式确实可以暂时减少符号冲突的概率, 但是并没有从根本上解决. 当程序很大的时候, 多个模块也有可能因为命名规范不严格造成命名冲突.</p><blockquote><p>因此像 C++ 这样后来设计的语言也开始考虑到了这个问题, 增加了命名空间的方法来解决多模块的符号冲突的问题</p></blockquote><p>现在的 Linux 下的 GCC 编译器默认情况下已经去掉了 C 语言符号前加 <code>_</code>, Windows 下的编译器还保持这样的传统. 例如 Visual C++ 编译器, cygwin, mingw. GCC 编译器也可以通过参数 <code>-fleading-underscore</code> <code>-fno-leading-underscore</code> 来打开/关闭是否在 C 符号前加下划线</p><h3 id="h3-4">C++符号修饰</h3><p>众所周知C++拥有类/继承/虚机制/重载/命名空间等强大的特性, 这也使得符号的管理更为复杂. 为了支持这些复杂的特性, 人们发明了 <b>符号修饰(Name Decoration)</b> 和 <b>符号改编(Name Mangling)</b>的机制</p><pre class="language-cpp"><code>#include &lt;iostream&gt;

int func(int);
float func(float);

class C {
public:
    int func(int);
    class C2 {
    public:
        int func(int);
    };
};

namespace N {
    int func(int);
    class C {
    public:
        int func(int);
    };
};

int main() {
    func(10);
    float x = 10;
    func(x);
    C c;
    c.func(10);
    C::C2 c2;
    c2.func(10);
    (N::func(10));
    N::C nc;
    nc.func(10);
    return 0;
}</code></pre><blockquote><p>注意这里需要调用一次, 单纯的声明不调用 g++ 似乎不会将其计入符号表</p></blockquote><p>上面的 C++ 代码定义了 6 个同名函数 func, 只不过它们的返回类型和参数以及所在的命名空间不相同. 这里引入一个术语叫做 <b>函数签名(Function Signature)</b>, 对于上面的 6 个函数每个都有一个独一无二的函数签名, 编译器在生成这个签名的时候会考虑 返回类型/参数/命名空间/函数名 等多种情况</p><pre class="language-shell"><code><span class="Token Program ID">g++</span><span class="Token SPACE"> </span><span class="Token OPTION">-c</span><span class="Token SPACE"> </span><span class="Token ID">func.cpp</span><span class="Token LF">
</span><span class="Token Program ID">readelf</span><span class="Token SPACE"> </span><span class="Token OPTION">-s</span><span class="Token SPACE"> </span><span class="Token ID">func.o</span></code></pre><p>可以看到原有的函数名被</p><pre class="language-shell"><code><span class="Token Program ID">Symbol</span><span class="Token SPACE"> </span><span class="Token ID">table</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.symtab</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">21</span><span class="Token SPACE"> </span><span class="Token ID">entries:</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token Program ID">Num:</span><span class="Token SPACE">    </span><span class="Token ID">Value</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">Type</span><span class="Token SPACE">    </span><span class="Token ID">Bind</span><span class="Token SPACE">   </span><span class="Token ID">Vis</span><span class="Token SPACE">      </span><span class="Token ID">Ndx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">FILE</span><span class="Token SPACE">    </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">ABS</span><span class="Token SPACE"> </span><span class="Token ID">func.cpp</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">3</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token ID">_ZStL8__ioinit</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">5</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000096</span><span class="Token SPACE">    </span><span class="Token NUMBER">86</span><span class="Token SPACE"> </span><span class="Token Program ID">FUNC</span><span class="Token SPACE">    </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">_Z41__static_ini</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">...</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">6</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000000000000e</span><span class="Token Program ID">c</span><span class="Token SPACE">    </span><span class="Token NUMBER">25</span><span class="Token SPACE"> </span><span class="Token ID">FUNC</span><span class="Token SPACE">    </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">_GLOBAL__sub_I_main</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">7</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">7</span><span class="Token SPACE"> </span><span class="Token ID">.rodata</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token NUMBER">150</span><span class="Token SPACE"> </span><span class="Token Program ID">FUNC</span><span class="Token SPACE">    </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">main</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">9</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">_Z4funci</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">10</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">_Z4funcf</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">11</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">_ZN1C4funcEi</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">12</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">_ZN1C2C24funcEi</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">13</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">_ZN1N4funcEi</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">14</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">_ZN1N1C4funcEi</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">15</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">__stack_chk_fail</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">16</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">_ZNSt8ios_base4I</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">...</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">17</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">HIDDEN</span><span class="Token SPACE">   </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">__dso_handle</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">18</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">_GLOBAL_OFFSET_TABLE_</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">19</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">_ZNSt8ios_base4I</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">...</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token NUMBER">20</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">__cxa_atexit</span></code></pre><p>其中 9-14 行为对应的符号名</p><table><tr><th>函数名</th><th>C++ 符号名</th><th>行号</th></tr><tr><td style="text-align:left">                int func(int)</td><td style="text-align:left">                _Z4funci</td><td style="text-align:left">                9</td></tr><tr><td style="text-align:left">                float func(float)</td><td style="text-align:left">                _Z4funcf</td><td style="text-align:left">                10</td></tr><tr><td style="text-align:left">                int C::func(int)</td><td style="text-align:left">                _ZN1C4funcEi</td><td style="text-align:left">                11</td></tr><tr><td style="text-align:left">                int C::C2::func(int)</td><td style="text-align:left">                _ZN1C2C24funcEi</td><td style="text-align:left">                12</td></tr><tr><td style="text-align:left">                int N::func(int)</td><td style="text-align:left">                _ZN1N4funcEi</td><td style="text-align:left">                13</td></tr><tr><td style="text-align:left">                int N::C::func(int)</td><td style="text-align:left">                _ZN1N1C4funcEi</td><td style="text-align:left">                14</td></tr></table><blockquote><p>上面只是一个比较简单的例子, 实际上 cpp 的名称修饰十分复杂, 您可参考 cpp-name-mangling 部分展开详细阅读</p></blockquote><p>我们可以使用 binutils 中的 c++filt 工具来解析一个被修饰过的名称, 例如</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">c++filt</span><span class="Token SPACE"> </span><span class="Token ID">_ZN1N1C4funcEi</span><span class="Token LF">
</span><span class="Token Program Function ID">N::C::func</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">int</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">c++filt</span><span class="Token SPACE"> </span><span class="Token ID">_ZN3foo3barE</span><span class="Token LF">
</span><span class="Token Program ID">foo::bar</span></code></pre><p>值得注意的是, 函数和变量的类型并没有被加入到修饰后的名称中, 所以不论这个变量的类型是什么它的名称都是一样的. 这种机制可以很好的避免命名冲突</p><p><b>不同编译器厂商的名称修饰方法可能不同</b>, 因此不同编译器编译产生的文件很有可能无法正常互相链接, 后面的 C++ABI 和 COM 节会详细讨论这个问题</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">nm</span><span class="Token SPACE"> </span><span class="Token OPTION">-C</span><span class="Token SPACE"> </span><span class="Token ID">func.o</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token ID">_GLOBAL_OFFSET_TABLE_</span><span class="Token LF">
</span><span class="Token NUMBER">00000000000000e</span><span class="Token Program ID">c</span><span class="Token SPACE"> </span><span class="Token ID">t</span><span class="Token SPACE"> </span><span class="Token ID">_GLOBAL__sub_I_main</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000096</span><span class="Token SPACE"> </span><span class="Token Program ID">t</span><span class="Token SPACE"> </span><span class="Token Function ID">__static_initialization_and_destruction_0</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">int</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token Function ID">func</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">float</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token Function ID">func</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">int</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token Function ID">C::C2::func</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">int</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token Function ID">C::func</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">int</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token Function ID">N::C::func</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">int</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token Function ID">N::func</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">int</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token Function ID">std::ios_base::Init::Init</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token Function ID">std::ios_base::Init::~Init</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">b</span><span class="Token SPACE"> </span><span class="Token ID">std::__ioinit</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token ID">__cxa_atexit</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token ID">__dso_handle</span><span class="Token LF">
</span><span class="Token SPACE">                 </span><span class="Token Program ID">U</span><span class="Token SPACE"> </span><span class="Token ID">__stack_chk_fail</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token Program ID">T</span><span class="Token SPACE"> </span><span class="Token ID">main</span></code></pre><h3 id="h3-5">extern &quot;C&quot;</h3><p>C++ 为了和 C 兼容, 在符号的管理上 C++ 有一个用来声明或者定义一个 C 的符号的 extern &quot;C&quot; 关键字用法</p><pre class="language-c"><code>extern &quot;C&quot; {
    int func(int);
    int var;
}</code></pre><p>在 extern &quot;C&quot; 内部的代码会被当作 C 语言代码处理, 所以这时候 C++ 的名称修饰机制不会起作用. 我们可以做一个很有意思的小实验, 尝试如下代码</p><pre class="language-cpp"><code>#include &lt;stdio.h&gt;

namespace myname {
    int var = 42;
}

extern &quot;C&quot; int _ZN6myname3varE;

int main() {
    printf(&quot;%d\n&quot;, _ZN6myname3varE);
    return 0;
}</code></pre><p>我们手动定义了以恶搞全局变量 var 并根据所掌握的 GCC 名称修饰规则手动声明一个外部符号</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">g++</span><span class="Token SPACE"> </span><span class="Token ID">manualnamemangling.cpp</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">a</span><span class="Token LF">
</span><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program PATH">./a</span><span class="Token LF">
</span><span class="Token NUMBER">42</span></code></pre><p>很多时候我们会碰到有些头文件声明了一些C语言的函数和全局变量,但是这个头文件可能会被C语言代码或C++代码包含.比如很常见的,我们的C语言库函数中的string.h中声明了memset这个函数,它的原型如下:</p><pre class="language-c"><code><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token FunctionName ID">memset</span><span class="Identifier DirectDeclaractor Token FunctionName SPACE"> </span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType VOID">void</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">size_t</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p>如果不加任何处理,当我们的C语言程序包含 string.h 的时候,并且用到了memset 这个函数,编译器会将memset符号引用正确处理;</p><p>但是在C++语言中,编译器会认为这个memset 函数是一个C++函数,将memset 的符号修饰成 <code>_Z6memsetPvii</code>,这样链接器就无法与C语言库中的memset符号进行链接.所以对于C++来说,必须使用 <code>extern &quot;C&quot;</code> 来声明memset 这个函数.但是C语言又不支持extern &quot;C&quot; 语法,如果为了兼容C语言和C++语言定义两套头文件,未免过于麻烦.幸好我们有一种很好的方法可以解决上述问题,就是使用C++的宏 <code>_cplusplus</code> ,C++编译器会在编译C++的程序时默认定义这个宏,我们可以使用条件宏来判断当前编译单元是不是C++代码.具体代码如下:</p><pre class="language-c"><code>#ifdef __cplusplus
extern &quot;C&quot; {
#endif

void *memset (void * , int, size_t ) ;

#ifdef __cplusplus
}
#endif</code></pre><p>如果当前编译单元是 C++ 代码, 那么 memset 会在 extern &quot;C&quot; 中被声明, 如果是 C 代码则直接声明. <b>上面这段代码的技巧几乎在所有系统头文件中都被用到了</b></p><h3 id="h3-6">强符号和弱符号</h3><p>在编程中经常会遇到的一种错误情况就是符号重复定义, 当多个目标文件中含有相同的名字全局符号定义, 那么当链接器在链接这些目标文件的时候就会出现符号重复定义的错误</p><p>对于 C/C++ 语言来说, <b>编译器默认函数和初始化的全局变量为强符号</b>, <b>未初始化的全局变量为弱符号</b></p><blockquote><p>这里有一点需要注意, 笔者使用的gcc版本是11.3.0, ld 的版本是 2.38, 对于下方的例子是无法编译通过的, <b>会存在两个强符号冲突!</b> 但是如果切换到 gcc-9 版本则没有这个问题, 对于clang10.0.1版本及以下同样可以通过编译,clang11.0.0及以上存在链接报错, 笔者在知乎提问了这个问题并且得到了解答: <a href="https://www.zhihu.com/question/600255688/answer/3022351083" target="_blank">C编译器版本导致强弱符号重定义的问题?</a>, 需要使用 -fcommon 参数</p></blockquote><pre class="language-c"><code><span class="Token COMMENT">// strong_weak_symbol.c</span><span class="Token LF">
</span><span class="Keyword Token StorageType EXTERN">extern</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">ext</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">weak_symbol</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">strong_symbol</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token GNU_C_Assembly Declaration _ATTRIBUTE">__attribute__</span><span class="Token GNU_C_Assembly BraceDepth-0 Declaration LPAREN">(</span><span class="BraceDepth-1 Token PrimaryExpression PostfixExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">weak</span><span class="BraceDepth-1 Token PrimaryExpression PostfixExpression RPAREN">)</span><span class="Token GNU_C_Assembly BraceDepth-0 Declaration RPAREN">)</span><span class="Token GNU_C_Assembly Declaration SPACE"> </span><span class="Identifier Token PrimaryExpression ID">weak_symbol2</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">2</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><pre class="language-c"><code><span class="Token COMMENT">// strong_symbol.c</span><span class="Token LF">
</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">weak_symbol</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">20</span><span class="Token Declaration SEMI">;</span></code></pre><p>对于 <code>strong_weak_symbol.o</code> 来说, 使用 <code>readelf -s</code> 结果如下所示</p><pre class="language-shell"><code><span class="Token Program ID">Symbol</span><span class="Token SPACE"> </span><span class="Token ID">table</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.symtab</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">7</span><span class="Token SPACE"> </span><span class="Token ID">entries:</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token Program ID">Num:</span><span class="Token SPACE">    </span><span class="Token ID">Value</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">Type</span><span class="Token SPACE">    </span><span class="Token ID">Bind</span><span class="Token SPACE">   </span><span class="Token ID">Vis</span><span class="Token SPACE">      </span><span class="Token ID">Ndx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">FILE</span><span class="Token SPACE">    </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">ABS</span><span class="Token SPACE"> </span><span class="Token ID">strong_weak_symbol.c</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">3</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">COM</span><span class="Token SPACE"> </span><span class="Token ID">weak_symbol</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token ID">strong_symbol</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">5</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">WEAK</span><span class="Token SPACE">   </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token ID">weak_symbol2</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">6</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">    </span><span class="Token NUMBER">15</span><span class="Token SPACE"> </span><span class="Token Program ID">FUNC</span><span class="Token SPACE">    </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">main</span></code></pre><p>而 <code>strong_symbol.o</code> 的结果如下</p><pre class="language-shell"><code><span class="Token Program ID">Symbol</span><span class="Token SPACE"> </span><span class="Token ID">table</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.symtab</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token ID">entries:</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token Program ID">Num:</span><span class="Token SPACE">    </span><span class="Token ID">Value</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">Type</span><span class="Token SPACE">    </span><span class="Token ID">Bind</span><span class="Token SPACE">   </span><span class="Token ID">Vis</span><span class="Token SPACE">      </span><span class="Token ID">Ndx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">FILE</span><span class="Token SPACE">    </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">ABS</span><span class="Token SPACE"> </span><span class="Token ID">strong_symbol.c</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">OBJECT</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token ID">weak_symbol</span></code></pre><p>可以注意到 <code>strong_weak_symbol.c</code> 中未初始化的全局变量 <code>weak_symbol</code> 定义在 COMMON 段, 作为一个弱符号. 而 <code>strong_symbol.c</code> 中的 <code>weak_symbol</code> 是一个已初始化的全局变量. 此时弱符号会被强符号所覆盖</p><p>针对强弱符号, 链接器会按照如下的规则处理被多次定义的全局符号:</p><ol start="1"><li><b>不允许强符号被定义多次</b>, 链接器报重复定义错误</li></ol><ol start="2"><li>如果一个符号某个目标文件中是弱符号, 那么选择其他文件中的强符号</li></ol><ol start="3"><li>如果一个符号在所有目标文件中都为弱符号, 那么选择占用空间最大的</li></ol><blockquote><p>上面的例子实际上对应的是第二种情况</p></blockquote><p><b>需要注意的是</b>, extern 修饰的符号既不是强符号也不是弱符号, 他甚至都不会进入符号表作为一个未定义符号.</p><h3 id="h3-7">强引用和弱引用</h3><p>我们看到的对外部目标文件的符号引用在目标文件被最终链接成可执行文件的时候, 它们需要被正确决议.</p><ul><li>强引用: 找到符号定义则正常决议; 如果没有找到该符号的定义, 则链接器报符号未定义错误</li></ul><ul><li>弱引用: 找到符号定义则正常决议; 如果没有找到该符号的定义, 则链接器也不会报错</li></ul><blockquote><p>对于未找到定义的弱引用, 链接器默认其值为0或一个特殊的值</p></blockquote><p>在 GCC 中可以使用 <code>__attribute__((weakref(&quot;tar&quot;))) static void foo();</code> 来声明 foo 是一个到 tar 的弱引用</p><blockquote><p>这里的相当混乱和奇怪, 实操下来和书上写的不太一样, 笔者也不是很清楚...</p></blockquote><pre class="language-c"><code><span class="Token HASH">#</span><span class="Preprocess ControlLine Keyword Token INCLUDE">include</span><span class="Preprocess ControlLine Keyword Token SPACE"> </span><span class="HeaderName ControlLine Token BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="HeaderName Token String STRING">stdio.h</span><span class="HeaderName ControlLine Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Preprocess ControlLine Keyword Token INCLUDE">include</span><span class="Preprocess ControlLine Keyword Token SPACE"> </span><span class="HeaderName ControlLine Token BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="HeaderName Token String STRING">pthread.h</span><span class="HeaderName ControlLine Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT">// int pthread_create(pthread_t*, const pthread_attr_t*, void *(*)(void*), void *) __attribute__ ((weak));</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-1 Token SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">pthread_create</span><span class="BraceDepth-1 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement Token BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">        </span><span class="Identifier Token PrimaryExpression FunctionCall ID">printf</span><span class="BraceDepth-2 Token UnaryExpression PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;This is multi-thread version</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="BraceDepth-2 Token UnaryExpression PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="CompoundStatement Token BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement SPACE"> </span><span class="Keyword Token SelectionStatement ELSE">else</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="CompoundStatement Token BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">        </span><span class="Identifier Token PrimaryExpression FunctionCall ID">printf</span><span class="BraceDepth-2 Token UnaryExpression PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;This is single-thread version</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="BraceDepth-2 Token UnaryExpression PostfixExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="CompoundStatement Token BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><p>上面的代码理论上来说应该是根据弱引用的方法判断当前程序是链接到了单线程的Glibc还是多线程的Glibc, 根据是否使用了了 -lpthread 选项</p><pre class="language-shell"><code><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token ID">pthread.c</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">pt</span><span class="Token LF">
</span><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token ID">pthread.c</span><span class="Token SPACE"> </span><span class="Token OPTION">-lpthread</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">pt</span></code></pre><h2 id="h2-8">调试信息</h2><p>目标文件中也可以保存调试信息, 几乎所有现代的编译器都成支持源代码级别的调试, 比如可以在函数里面设置断点, 监视变量变化, 单步执行等等</p><p>前提是编译器必须提前将源代码和目标代码之间的关系</p><ul><li>目标代码的地址对应源代码中的哪一行</li></ul><ul><li>函数和变量的类型</li></ul><ul><li>结构体的定义</li></ul><ul><li>字符串</li></ul><p>有些高级的编译器和调试器甚至支持查看 STL 容器里面的内容, 即程序员在调试的过程中可以直接观察 STL 容器中成员的值</p><p>现在 ELF 采用的是一个叫做 DWARF(debug with arbitary record format) 的标准调试信息格式</p><p>有关调试信息的部分笔者将会在 &quot;调试信息&quot; 这一节展开, 作为扩展部分</p></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../linux/目录" >linux</a><ul><li><a href="../../linux/目录" >目录</a></li></ul><ul><li><a href="../../linux/终端" >终端</a></li></ul></li></ul><ul><li><a href="../../libc/LD_PRELOAD" >libc</a><ul><li><a href="../../libc/LD_PRELOAD" >LD_PRELOAD</a></li></ul></li></ul><ul><li><a href="../../工具库/命令行参数解析" >工具库</a><ul><li><a href="../../工具库/命令行参数解析" >命令行参数解析</a></li></ul></li></ul><ul><li><a href="../../miniCRT/ELF文件格式" >miniCRT</a><ul><li><a href="../../miniCRT/ELF文件格式" >ELF文件格式</a></li></ul><ul><li><a href="../../miniCRT/ELF文件结构详解" >ELF文件结构详解</a></li></ul><ul><li><a href="../../miniCRT/符号表" >符号表</a></li></ul><ul><li><a href="../../miniCRT/静态链接" >静态链接</a></li></ul></li></ul><ul><li><a href="../../阅读资料/起始地址故事" >阅读资料</a><ul><li><a href="../../阅读资料/起始地址故事" >起始地址故事</a></li></ul><ul><li><a href="../../阅读资料/编译器与C++" >编译器与C++</a></li></ul><ul><li><a href="../../阅读资料/交叉编译" >交叉编译</a></li></ul><ul><li><a href="../../阅读资料/AUB" >AUB</a></li></ul><ul><li><a href="../../阅读资料/gettext" >gettext</a></li></ul><ul><li><a href="../../阅读资料/gcc参数" >gcc参数</a></li></ul><ul><li><a href="../../阅读资料/函数命名规则" >函数命名规则</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../miniCRT/ELF文件结构详解","../../miniCRT/静态链接","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>