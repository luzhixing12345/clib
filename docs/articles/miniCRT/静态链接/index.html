<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/shell.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/libc.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">静态链接</a><ul><li><a href="#h2-1">空间和地址分配</a><ul><li><a href="#h3-2">空间地址分配的含义</a></li></ul><ul><li><a href="#h3-3">手动链接</a></li></ul></li></ul><ul><li><a href="#h2-4">符号解析和重定位</a><ul><li><a href="#h3-5">符号解析</a></li></ul></li></ul><ul><li><a href="#h2-6">静态库链接</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">静态链接</h1><p>链接的这个过程主要解决如何将多个目标文件链接起来得到一个可执行文件</p><p>假设分别有如下的两个文件 a.c b.c</p><blockquote><p>注意这里和书上的有点区别在于a.c中添加了 extern swap的声明</p></blockquote><pre class="language-c"><code><span class="Keyword Token StorageType EXTERN">extern</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">shared</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="FunctionReturnType Keyword Token StorageType EXTERN">extern</span><span class="FunctionReturnType Keyword Token StorageType SPACE"> </span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">swap</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">a</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">b</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">a</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">100</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">swap</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="PPtoken Token AMPERSAND">&amp;</span><span class="Identifier Token ID">a</span><span class="PPtoken Token COMMA">,</span><span class="PPtoken Token SPACE"> </span><span class="PPtoken Token AMPERSAND">&amp;</span><span class="Identifier Token ID">shared</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><pre class="language-c"><code><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">shared</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">1</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">swap</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">a</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">b</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Identifier Token PrimaryExpression ID">a</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression XOR_ASSIGN">^=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Identifier Token PrimaryExpression ID">b</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Identifier Token PrimaryExpression ID">a</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression XOR_ASSIGN">^=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Identifier Token PrimaryExpression ID">b</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><h2 id="h2-1">空间和地址分配</h2><p>我们知道可执行文件中的代码拗断和数据段都是由输入的目标文件合并起来的, 那么对于多目标文件来说, 链接器是如何将各个段合并到输出文件的呢? 或者说, 输出文件中的空间应该如何分配给输入文件?</p><p>一个简单的方法就是按次序叠加起来, 如下所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230515145541.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230515145541.png" alt="20230515145541"></a></p><p>但是这种方式有很严重的问题, 首先对于多个输入文件的情况会出现很多零散的段, 每一个段都有一定的地址和空间对齐要求, 对于 x86 的硬件来说段的装在地址和空间的对齐单位是 4096 字节, 也就是说即使一个段的长度只有1字节, 他也需要在内存中占据 4096 字节, 因此这并不是一个好的方案</p><p>实际上使用的方式是将各个段合并到一起, 相同性质的段组合为一个大段, 如下所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230515145513.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230515145513.png" alt="20230515145513"></a></p><h3 id="h3-2">空间地址分配的含义</h3><p>前文提到了 .bss 段实际上并不占用文件的空间, 在装载时占用地址空间. 那么这里我们可以思考一个问题, <b>就是所谓的空间分配到底是什么空间</b>?</p><p>这样讲起来有点抽象, 不如举一个例子. 对于下面的代码, 全局变量中有一个 x[1000], 由于并未初始化所以它应该分配在 bss 段中</p><pre class="language-c"><code><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">x</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token PrimaryExpression Constant NUMBER">1000</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><pre class="language-shell"><code><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token ID">bss.c</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">bss</span><span class="Token LF">
</span><span class="Token Program ID">nm</span><span class="Token SPACE"> </span><span class="Token ID">bss</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token COMMENT"># 0000000000004040 B x</span></code></pre><blockquote><p>B 对应 .bss, D 对应 .data</p></blockquote><p>可以看到最后一行说明了 x 确实分配在 bss 段中, 通过 du 可以得到这个可执行文件的大小是 16KB</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">du</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">bss</span><span class="Token LF">
</span><span class="Token NUMBER">16</span><span class="Token Program ID">K</span><span class="Token SPACE">     </span><span class="Token ID">bss</span></code></pre><p>但是如果我们稍微修改一下</p><pre class="language-c"><code><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">x</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token PrimaryExpression Constant NUMBER">1000</span><span class="DirectDeclaractorPostfix Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="DirectDeclaractorPostfix Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="InitDeclarator Token Initializer BraceDepth-0 LCURLY_BRACE">{</span><span class="Token PrimaryExpression Constant NUMBER">1</span><span class="InitDeclarator Token Initializer BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><p>此时可以看到, x 由于已经被初始化了所以被分配在 data 段中, 并且文件的体积也扩大到了 20KB, 多出来的 4KB 显然就是 x 数组的大小</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">nm</span><span class="Token SPACE"> </span><span class="Token ID">bss</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000004020</span><span class="Token SPACE"> </span><span class="Token Program ID">D</span><span class="Token SPACE"> </span><span class="Token ID">x</span><span class="Token LF">
</span><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">du</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">bss</span><span class="Token LF">
</span><span class="Token NUMBER">20</span><span class="Token Program ID">K</span><span class="Token SPACE">     </span><span class="Token ID">bss</span></code></pre><p>实际上地址和空间有两部分的含义, <b>一个是指输出在可执行文件中的空间, 第二个是装载后的虚拟地址中的虚拟地址空间</b></p><p>对于有实际数据的段, 比如 .text, .data, 它们在文件中和虚拟地址中都要分配空间, 因为在二者中他们都存在</p><p>但是对于 .bss 这样的段来说<b>不需要在可执行文件中分配地址空间</b>, 只需要在虚拟地址空间中分配空间</p><p>换而言之, 无论使用 <code>int x[1000]</code> 还是 <code>int x[1000] = {1}</code>, 都确实在程序中定义了一个大小为1000的int类型的数组x, 只不过由于前面的x没有初始化, 所以不需要在可执行文件中为其开辟一块 4KB 大小的空间来存放这个数组 x 的所有值, 而是用一个记录说明符号 x, 大小 4000, 这样就可以节约可执行文件的大小了</p><h3 id="h3-3">手动链接</h3><p>链接器一般采用<b>两步链接</b></p><ul><li><b>第一步 空间和地址分配</b>: 扫描所有输入目标文件, 获得它们每一个段的长度, 属性和位置. 将输入目标文件中的符号表中所有的符号定义和符号引用收集起来统一放到一个全局符号表中.<p>在这一步中链接器能够获取所有的输入目标文件的段长度, 并且将它们合并, 计算出输出文件中各个段合并后的长度和位置, 并建立映射关系</p></li></ul><ul><li><b>第二步 符号解析与重定位</b>: 使用上一步收集到的信息, 读取输入文件中的段和数据以及重定位的信息, 进行符号解析与重定位, 调整代码中的地址<p>实际上这一步是链接的核心, 特别是重定位</p></li></ul><p>可以尝试使用 ld 将 a.o 和 b.o 链接起来, 但是这里书上有一点小问题, 首先是需要修改一下程序, 手动添加 exit, 不然程序不知道在哪里终止, 运行起来会出现 segment fault 的问题</p><blockquote><p>参考 <a href="https://zhuanlan.zhihu.com/p/150793679" target="_blank">https://zhuanlan.zhihu.com/p/150793679</a></p><p><a href="https://stackoverflow.com/questions/4492799/undefined-reference-to-stack-chk-fail" target="_blank">https://stackoverflow.com/questions/4492799/undefined-reference-to-stack-chk-fail</a></p></blockquote><pre class="language-c"><code><span class="Keyword Token StorageType EXTERN">extern</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">shared</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="FunctionReturnType Keyword Token StorageType EXTERN">extern</span><span class="FunctionReturnType Keyword Token StorageType SPACE"> </span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">swap</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">a</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Token Declarator Pointer POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">b</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier INT">int</span><span class="Token Keyword BaseType FunctionReturnType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 LPAREN">(</span><span class="DirectDeclaractor Token Declarator BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Token BraceDepth-0 Function LCURLY_BRACE">{</span><span class="CompoundStatement Token Function LF">
</span><span class="CompoundStatement Token Function SPACE">    </span><span class="Keyword Token TypeSpecifier BaseType INT">int</span><span class="Keyword Token TypeSpecifier BaseType SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">a</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Token PrimaryExpression Constant NUMBER">100</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">swap</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="PPtoken Token AMPERSAND">&amp;</span><span class="Identifier Token ID">a</span><span class="PPtoken Token COMMA">,</span><span class="PPtoken Token SPACE"> </span><span class="PPtoken Token AMPERSAND">&amp;</span><span class="Identifier Token ID">shared</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Keyword Token GNU_C_Assembly ASM">asm</span><span class="BraceDepth-1 Token GNU_C_Assembly LPAREN">(</span><span class="Token String STRING">&quot;movq $66,%rdi </span><span class="Control Token String STRING">\n</span><span class="Control Token String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;movq $60,%rax </span><span class="Control Token String STRING">\n</span><span class="Control Token String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="Token LF">
</span><span class="Token SPACE">        </span><span class="Token String STRING">&quot;syscall </span><span class="Control Token String STRING">\n</span><span class="Control Token String STRING">\t</span><span class="Token String STRING">&quot;</span><span class="BraceDepth-1 Token GNU_C_Assembly RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement Token BraceDepth-0 Function RCURLY_BRACE">}</span></code></pre><p>其次是在编译的时候使用 <code>-fno-stack-protector</code> 关闭栈检查</p><pre class="language-shell"><code><span class="Token Program ID">gcc</span><span class="Token SPACE"> </span><span class="Token OPTION">-fno-stack-protector</span><span class="Token SPACE"> </span><span class="Token OPTION">-c</span><span class="Token SPACE"> </span><span class="Token ID">a.c</span><span class="Token SPACE"> </span><span class="Token ID">b.c</span><span class="Token LF">
</span><span class="Token Program ID">ld</span><span class="Token SPACE"> </span><span class="Token ID">a.o</span><span class="Token SPACE"> </span><span class="Token ID">b.o</span><span class="Token SPACE"> </span><span class="Token OPTION">-e</span><span class="Token SPACE"> </span><span class="Token ID">main</span><span class="Token SPACE"> </span><span class="Token OPTION">-o</span><span class="Token SPACE"> </span><span class="Token ID">ab</span></code></pre><blockquote><p>-e 表示将 main 函数作为程序的入口, 默认的入口程序是 _start</p></blockquote><p>可以使用 objdump 来查看 a.o b.o ab 的地址分配情况, 如下所示</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">a.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">a.o:</span><span class="Token SPACE">     </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Sections:</span><span class="Token LF">
</span><span class="Token Program ID">Idx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE">      </span><span class="Token ID">VMA</span><span class="Token SPACE">               </span><span class="Token ID">LMA</span><span class="Token SPACE">               </span><span class="Token ID">File</span><span class="Token SPACE"> </span><span class="Token ID">off</span><span class="Token SPACE">  </span><span class="Token ID">Algn</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">.text</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000040</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">RELOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">CODE</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000080</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token Program ID">.bss</span><span class="Token SPACE">          </span><span class="Token NUMBER">00000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000080</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">ALLOC</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token Program ID">.comment</span><span class="Token SPACE">      </span><span class="Token NUMBER">0000002e</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000080</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.GNU-stack</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">ae</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">5</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.gnu.property</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">b0</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">6</span><span class="Token SPACE"> </span><span class="Token Program ID">.eh_frame</span><span class="Token SPACE">     </span><span class="Token NUMBER">00000038</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">d0</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">RELOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">b.o</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">b.o:</span><span class="Token SPACE">     </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Sections:</span><span class="Token LF">
</span><span class="Token Program ID">Idx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE">      </span><span class="Token ID">VMA</span><span class="Token SPACE">               </span><span class="Token ID">LMA</span><span class="Token SPACE">               </span><span class="Token ID">File</span><span class="Token SPACE"> </span><span class="Token ID">off</span><span class="Token SPACE">  </span><span class="Token ID">Algn</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">.text</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000047</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">CODE</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000004</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000088</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">2</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token Program ID">.bss</span><span class="Token SPACE">          </span><span class="Token NUMBER">00000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000008</span><span class="Token ID">c</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">ALLOC</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token Program ID">.comment</span><span class="Token SPACE">      </span><span class="Token NUMBER">0000002e</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000008</span><span class="Token ID">c</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.GNU-stack</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">ba</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">5</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.gnu.property</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">c0</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">6</span><span class="Token SPACE"> </span><span class="Token Program ID">.eh_frame</span><span class="Token SPACE">     </span><span class="Token NUMBER">00000038</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000e0</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">RELOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/miniCRT/notes</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">objdump</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token ID">ab</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">ab:</span><span class="Token SPACE">     </span><span class="Token ID">file</span><span class="Token SPACE"> </span><span class="Token ID">format</span><span class="Token SPACE"> </span><span class="Token ID">elf64-x86-64</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token Program ID">Sections:</span><span class="Token LF">
</span><span class="Token Program ID">Idx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE">      </span><span class="Token ID">VMA</span><span class="Token SPACE">               </span><span class="Token ID">LMA</span><span class="Token SPACE">               </span><span class="Token ID">File</span><span class="Token SPACE"> </span><span class="Token ID">off</span><span class="Token SPACE">  </span><span class="Token ID">Algn</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.gnu.property</span><span class="Token SPACE"> </span><span class="Token NUMBER">00000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000000004001</span><span class="Token ID">c8</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000000004001</span><span class="Token ID">c8</span><span class="Token SPACE">  </span><span class="Token NUMBER">000001</span><span class="Token ID">c8</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token Program ID">.text</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000087</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000401000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000401000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00001000</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">CODE</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token SPACE"> </span><span class="Token Program ID">.eh_frame</span><span class="Token SPACE">     </span><span class="Token NUMBER">00000058</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000402000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000402000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00002000</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">         </span><span class="Token NUMBER">00000004</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000404000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000404000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00003000</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">2</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">ALLOC</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">LOAD</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">DATA</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">4</span><span class="Token SPACE"> </span><span class="Token Program ID">.comment</span><span class="Token SPACE">      </span><span class="Token NUMBER">0000002</span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00003004</span><span class="Token SPACE">  </span><span class="Token NUMBER">2</span><span class="Token MUL">*</span><span class="Token MUL">*</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">                  </span><span class="Token Program ID">CONTENTS</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">READONLY</span></code></pre><p>可以发现 a.o 和 b.o 的 .text 段以及 .data 段大小的和刚好是 ab 中的数值, 也印证了合并的方式</p><p>VMA(Virtual Memory Address) 代表虚拟地址, LMA(Load Memory Address)加载地址, 正常情况下这两个值应该是一样的. 但是在有的嵌入式系统中这两个值是不同的</p><p>在链接之前目标文件中的所有段的 VMA 都是0. 而链接后可执行文件中的各个段都被分配到了相应的虚拟地址, 整个程序.text段从 0x401000 开始</p><blockquote><p><a href="https://www.zhihu.com/question/552957041/answer/2738625402" target="_blank">书上说代码地址总是从0x400000开始,但是查看编译好的elf头起始地址是从0开始的,这是为什么?</a></p></blockquote><p>当将多个目标文件合并为一个可执行文件之后, 这时候每一个段的虚拟地址已经确定下来了, 比如 .text 段从 <code>0x401000</code> 开始, .data 段从 <code>0x404000</code> 开始. 对于每一个目标文件中的每一个符号, 它们在对应的目标文件的段中有一个固定的偏移量, 比如 X. 那么当最后得到可执行文件之后只需要对应的从 <code>0x401000 + X</code> 即可得到最终的全局符号地址</p><h2 id="h2-4">符号解析和重定位</h2><p>使用 objdump -d 反汇编 a.o 可以得到如下程序, 其中注意到 17 处 48 8d 15 <b>00 00 00 00</b> 和 24 处的 e8 <b>00 00 00 00</b>, 分别对应 shared 的地址以及 swap 的地址. 由于在这个阶段编译器并不知道 shared 和 swap 的具体地址, 所以暂时把地址填 0</p><pre class="language-shell"><code><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token Program ID">main</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token Program ID">f3</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token ID">f</span><span class="Token SPACE"> </span><span class="Token NUMBER">1e</span><span class="Token SPACE"> </span><span class="Token ID">fa</span><span class="Token SPACE">             </span><span class="Token ID">endbr64</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">4</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">55</span><span class="Token SPACE">                      </span><span class="Token Program ID">push</span><span class="Token SPACE">   </span><span class="Token MOD">%</span><span class="Token ID">rbp</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">5</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token Program ID">e5</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token MOD">%</span><span class="Token ID">rsp</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rbp</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">83</span><span class="Token SPACE"> </span><span class="Token Program ID">ec</span><span class="Token SPACE"> </span><span class="Token NUMBER">10</span><span class="Token SPACE">             </span><span class="Token ID">sub</span><span class="Token SPACE">    </span><span class="Token VARIANT">$0x10</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rsp</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token Program ID">c:</span><span class="Token SPACE">   </span><span class="Token ID">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">45</span><span class="Token SPACE"> </span><span class="Token ID">fc</span><span class="Token SPACE"> </span><span class="Token NUMBER">64</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">movl</span><span class="Token SPACE">   </span><span class="Token VARIANT">$0x64</span><span class="Token COMMA">,</span><span class="Token MINUS">-</span><span class="Token NUMBER">0x4</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token MOD">%</span><span class="Token ID">rbp</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">13</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="Token Program ID">d</span><span class="Token SPACE"> </span><span class="Token NUMBER">45</span><span class="Token SPACE"> </span><span class="Token ID">fc</span><span class="Token SPACE">             </span><span class="Token ID">lea</span><span class="Token SPACE">    </span><span class="Token MINUS">-</span><span class="Token NUMBER">0x4</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token MOD">%</span><span class="Token ID">rbp</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">17</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="Token Program ID">d</span><span class="Token SPACE"> </span><span class="Token NUMBER">15</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">lea</span><span class="Token SPACE">    </span><span class="Token NUMBER">0x0</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token MOD">%</span><span class="Token ID">rip</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rdx</span><span class="Token SPACE">        </span><span class="Token COMMENT"># 1e &lt;main+0x1e&gt;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1e</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token Program ID">d6</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token MOD">%</span><span class="Token ID">rdx</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rsi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">21</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token Program ID">c7</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token MOD">%</span><span class="Token ID">rax</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rdi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">24</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token Program ID">e8</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">          </span><span class="Token ID">call</span><span class="Token SPACE">   </span><span class="Token NUMBER">29</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">main+0x29</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">29</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token Program ID">c7</span><span class="Token SPACE"> </span><span class="Token ID">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">42</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token VARIANT">$0x42</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rdi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">30</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token Program ID">c7</span><span class="Token SPACE"> </span><span class="Token ID">c0</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="Token ID">c</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token VARIANT">$0x3c</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">37</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token Program ID">f</span><span class="Token SPACE"> </span><span class="Token NUMBER">05</span><span class="Token SPACE">                   </span><span class="Token ID">syscall</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">39</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token Program ID">b8</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">          </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token VARIANT">$0x0</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">eax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3e</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token Program ID">c9</span><span class="Token SPACE">                      </span><span class="Token ID">leave</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3</span><span class="Token Program ID">f:</span><span class="Token SPACE">   </span><span class="Token ID">c3</span><span class="Token SPACE">                      </span><span class="Token ID">ret</span></code></pre><p>对于这里的地址重定位的计算交给了链接器, 通过前面的空间和地址分配, 链接器就可以确定所有符号的虚拟地址了, 就对这些位置进行修正. 可以通过 objdump -d ab 来查看最后的可执行文件当中的代码段, 如下所示</p><pre class="language-shell"><code><span class="Token NUMBER">0000000000401000</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token Program ID">main</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401000</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token Program ID">f3</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token ID">f</span><span class="Token SPACE"> </span><span class="Token NUMBER">1e</span><span class="Token SPACE"> </span><span class="Token ID">fa</span><span class="Token SPACE">             </span><span class="Token ID">endbr64</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401004</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">55</span><span class="Token SPACE">                      </span><span class="Token Program ID">push</span><span class="Token SPACE">   </span><span class="Token MOD">%</span><span class="Token ID">rbp</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401005</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token Program ID">e5</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token MOD">%</span><span class="Token ID">rsp</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rbp</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401008</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">83</span><span class="Token SPACE"> </span><span class="Token Program ID">ec</span><span class="Token SPACE"> </span><span class="Token NUMBER">10</span><span class="Token SPACE">             </span><span class="Token ID">sub</span><span class="Token SPACE">    </span><span class="Token VARIANT">$0x10</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rsp</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">40100</span><span class="Token Program ID">c:</span><span class="Token SPACE">       </span><span class="Token ID">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">45</span><span class="Token SPACE"> </span><span class="Token ID">fc</span><span class="Token SPACE"> </span><span class="Token NUMBER">64</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">movl</span><span class="Token SPACE">   </span><span class="Token VARIANT">$0x64</span><span class="Token COMMA">,</span><span class="Token MINUS">-</span><span class="Token NUMBER">0x4</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token MOD">%</span><span class="Token ID">rbp</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401013</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="Token Program ID">d</span><span class="Token SPACE"> </span><span class="Token NUMBER">45</span><span class="Token SPACE"> </span><span class="Token ID">fc</span><span class="Token SPACE">             </span><span class="Token ID">lea</span><span class="Token SPACE">    </span><span class="Token MINUS">-</span><span class="Token NUMBER">0x4</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token MOD">%</span><span class="Token ID">rbp</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401017</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="Token Program ID">d</span><span class="Token SPACE"> </span><span class="Token NUMBER">15</span><span class="Token SPACE"> </span><span class="Token ID">e2</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token ID">f</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">lea</span><span class="Token SPACE">    </span><span class="Token NUMBER">0x2fe2</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token MOD">%</span><span class="Token ID">rip</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rdx</span><span class="Token SPACE">        </span><span class="Token COMMENT"># 404000 &lt;shared&gt;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">40101e</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token Program ID">d6</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token MOD">%</span><span class="Token ID">rdx</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rsi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401021</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token NUMBER">89</span><span class="Token SPACE"> </span><span class="Token Program ID">c7</span><span class="Token SPACE">                </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token MOD">%</span><span class="Token ID">rax</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rdi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401024</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token Program ID">e8</span><span class="Token SPACE"> </span><span class="Token NUMBER">17</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">          </span><span class="Token ID">call</span><span class="Token SPACE">   </span><span class="Token NUMBER">401040</span><span class="Token SPACE"> </span><span class="Token REDIRECT_FROM">&lt;</span><span class="Token ID">swap</span><span class="Token REDIRECT_TO">&gt;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401029</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token Program ID">c7</span><span class="Token SPACE"> </span><span class="Token ID">c7</span><span class="Token SPACE"> </span><span class="Token NUMBER">42</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token VARIANT">$0x42</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rdi</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401030</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">48</span><span class="Token SPACE"> </span><span class="Token Program ID">c7</span><span class="Token SPACE"> </span><span class="Token ID">c0</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="Token ID">c</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">    </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token VARIANT">$0x3c</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">rax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401037</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token Program ID">f</span><span class="Token SPACE"> </span><span class="Token NUMBER">05</span><span class="Token SPACE">                   </span><span class="Token ID">syscall</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">401039</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token Program ID">b8</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">          </span><span class="Token ID">mov</span><span class="Token SPACE">    </span><span class="Token VARIANT">$0x0</span><span class="Token COMMA">,</span><span class="Token MOD">%</span><span class="Token ID">eax</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">40103e</span><span class="Token COLON">:</span><span class="Token SPACE">       </span><span class="Token Program ID">c9</span><span class="Token SPACE">                      </span><span class="Token ID">leave</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">40103</span><span class="Token Program ID">f:</span><span class="Token SPACE">       </span><span class="Token ID">c3</span><span class="Token SPACE">                      </span><span class="Token ID">ret</span></code></pre><p>可以注意到之前填 0 的地址已经被计算完毕</p><p>在 ELF 文件当中有一个重定位表(Relocation Table) 的结构专门用于保存这些与重定位相关的信息, 它在 ELF 文件中往往是一个或多个段. 比如 .text 如果有要被重定位的地方那么就有一个相应的叫做 .rela.text 的段(前面加上 <code>.rela</code>). 例如对于下面的段来说, 使用 <code>readelf -r</code> 查看即可得到每一个重定位表, 一共四个</p><pre class="language-shell"><code><span class="Token Program ID">Section</span><span class="Token SPACE"> </span><span class="Token ID">Headers:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Program ID">Nr</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">              </span><span class="Token ID">Type</span><span class="Token SPACE">             </span><span class="Token ID">Address</span><span class="Token SPACE">           </span><span class="Token ID">Offset</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token Program ID">Size</span><span class="Token SPACE">              </span><span class="Token ID">EntSize</span><span class="Token SPACE">          </span><span class="Token ID">Flags</span><span class="Token SPACE">  </span><span class="Token ID">Link</span><span class="Token SPACE">  </span><span class="Token ID">Info</span><span class="Token SPACE">  </span><span class="Token ID">Align</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE">                   </span><span class="Token Program ID">NULL</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000000</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.text</span><span class="Token SPACE">             </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000003</span><span class="Token Program ID">bfd</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token ID">AX</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.rela.text</span><span class="Token SPACE">        </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00005</span><span class="Token ID">c00</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000003240</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Token Program ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">14</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.data</span><span class="Token SPACE">             </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00003</span><span class="Token ID">c3d</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token Program ID">WA</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">4</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.bss</span><span class="Token SPACE">              </span><span class="Token ID">NOBITS</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00003</span><span class="Token ID">c40</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000432</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token Program ID">WA</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">32</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">5</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.rodata</span><span class="Token SPACE">           </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00003</span><span class="Token ID">c40</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000001210</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token Program ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">6</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.rela.rodata</span><span class="Token SPACE">      </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00008e40</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000</span><span class="Token Program ID">a98</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Token ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">14</span><span class="Token SPACE">     </span><span class="Token NUMBER">5</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">7</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.data.rel.local</span><span class="Token SPACE">   </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00004e50</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000008</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token Program ID">WA</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.rela.data.r</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">...</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000098</span><span class="Token ID">d8</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Token Program ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">14</span><span class="Token SPACE">     </span><span class="Token NUMBER">7</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">9</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.comment</span><span class="Token SPACE">          </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00004e58</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">000000000000002e</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000001</span><span class="Token SPACE">  </span><span class="Token Program ID">MS</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">10</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.GNU-stack</span><span class="Token SPACE">   </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00004e86</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">11</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.note.gnu.pr</span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token ID">...</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">NOTE</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00004e88</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token Program ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">12</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.eh_frame</span><span class="Token SPACE">         </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00004e</span><span class="Token ID">a8</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">00000000000003e8</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Token Program ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">13</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.rela.eh_frame</span><span class="Token SPACE">    </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000098</span><span class="Token ID">f0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">00000000000002</span><span class="Token Program ID">d0</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Token ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">14</span><span class="Token SPACE">    </span><span class="Token NUMBER">12</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">14</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.symtab</span><span class="Token SPACE">           </span><span class="Token ID">SYMTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00005290</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000660</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">          </span><span class="Token NUMBER">15</span><span class="Token SPACE">    </span><span class="Token NUMBER">13</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">15</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.strtab</span><span class="Token SPACE">           </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000058</span><span class="Token ID">f0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">000000000000030</span><span class="Token Program ID">b</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token NUMBER">16</span><span class="Token BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token Program ID">.shstrtab</span><span class="Token SPACE">         </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00009</span><span class="Token ID">bc0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">000000000000008e</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span></code></pre><pre class="language-shell"><code><span class="Token Program ID">Relocation</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.rela.text</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">at</span><span class="Token SPACE"> </span><span class="Token ID">offset</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x5c00</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">536</span><span class="Token SPACE"> </span><span class="Token ID">entries:</span><span class="Token LF">
</span><span class="Token Program ID">...</span><span class="Token LF">
</span><span class="Token Program ID">Relocation</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.rela.rodata</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">at</span><span class="Token SPACE"> </span><span class="Token ID">offset</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x8e40</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">113</span><span class="Token SPACE"> </span><span class="Token ID">entries:</span><span class="Token LF">
</span><span class="Token Program ID">...</span><span class="Token LF">
</span><span class="Token Program ID">Relocation</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.rela.data.rel.local</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">at</span><span class="Token SPACE"> </span><span class="Token ID">offset</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x98d8</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">entry:</span><span class="Token LF">
</span><span class="Token Program ID">...</span><span class="Token LF">
</span><span class="Token Program ID">Relocation</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.rela.eh_frame</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">at</span><span class="Token SPACE"> </span><span class="Token ID">offset</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x98f0</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">30</span><span class="Token SPACE"> </span><span class="Token ID">entries:</span><span class="Token LF">
</span><span class="Token Program ID">...</span></code></pre><p>除此之外对于重定位表可以观察得到, 其 TYPE 是 RELA, Link 和 Info 分别指向对应符号表 和 需要重定位的段</p><pre class="language-c"><code><span class="Keyword Token StorageType TYPEDEF">typedef</span><span class="Keyword Token StorageType SPACE"> </span><span class="Structure Token StructureType Keyword TypeSpecifier STRUCT">struct</span><span class="Structure Token StructureType Keyword TypeSpecifier SPACE"> </span><span class="Structure Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Structure Token LF">
</span><span class="Structure Token SPACE">   </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">Elf64_Addr</span><span class="Keyword Token TypeSpecifier Typedefine SPACE"> </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">r_offset</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">   </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint64_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">   </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">r_info</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">   </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">int64_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">    </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">r_addend</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="Structure Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Structure Token SPACE"> </span><span class="Identifier DirectDeclaractor Token Typedefine ID">Elf64_Rela</span><span class="Token Declaration SEMI">;</span></code></pre><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516190713.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516190713.png" alt="20230516190713"></a></p><p>输出中的 offset 对应 r_offset, r_info 的低 32 位是符号的重定位类型, 高32位是符号的在符号表中的索引, 最后的偏移量对应 r_addend</p><h3 id="h3-5">符号解析</h3><p>在编译程序的过程中, undefined reference 是一个非常常见错误</p><p>对于一个目标文件, 我们可以看到 GLOBAL 中的三个符号中的 shared swap 都是 UND, 即 undefined 未定义类型.</p><p><b>这种未定义的符号说明了文件中有关于他们的重定位项, 如果链接器扫描了所有输入目标文件之后仍然有未定义符号就会报未定义错误</b></p><pre class="language-shell"><code><span class="Token Program ID">Symbol</span><span class="Token SPACE"> </span><span class="Token ID">table</span><span class="Token SPACE"> </span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">.symtab</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token SPACE"> </span><span class="Token ID">contains</span><span class="Token SPACE"> </span><span class="Token NUMBER">6</span><span class="Token SPACE"> </span><span class="Token ID">entries:</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token Program ID">Num:</span><span class="Token SPACE">    </span><span class="Token ID">Value</span><span class="Token SPACE">          </span><span class="Token ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">Type</span><span class="Token SPACE">    </span><span class="Token ID">Bind</span><span class="Token SPACE">   </span><span class="Token ID">Vis</span><span class="Token SPACE">      </span><span class="Token ID">Ndx</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">FILE</span><span class="Token SPACE">    </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">ABS</span><span class="Token SPACE"> </span><span class="Token ID">a.c</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">SECTION</span><span class="Token SPACE"> </span><span class="Token ID">LOCAL</span><span class="Token SPACE">  </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">3</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">    </span><span class="Token NUMBER">64</span><span class="Token SPACE"> </span><span class="Token Program ID">FUNC</span><span class="Token SPACE">    </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">    </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="Token ID">main</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">shared</span><span class="Token LF">
</span><span class="Token SPACE">     </span><span class="Token NUMBER">5</span><span class="Token COLON">:</span><span class="Token SPACE"> </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="Token Program ID">NOTYPE</span><span class="Token SPACE">  </span><span class="Token ID">GLOBAL</span><span class="Token SPACE"> </span><span class="Token ID">DEFAULT</span><span class="Token SPACE">  </span><span class="Token ID">UND</span><span class="Token SPACE"> </span><span class="Token ID">swap</span></code></pre><p>接下来详细的讨论一下如何进行指令修正.</p><p>对于每一个需要重定位的符号, 其 offset 对应了其重定位的位置(主要是 .text 段), 同时还有两个重要信息分别是他们的重定位类型 <code>R_X86_64_PC32</code> 和 <code>R_X86_64_PLT32</code> , 以及最后的 Addend 的值. 如下图所示</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516201225.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516201225.png" alt="20230516201225"></a></p><p>那么如何在链接得到可执行文件的时候确定这个最终应该跳转的地址位置呢? 这主要取决于选址方式, 目前采取的主流重定位方式都是相对地址寻址</p><ul><li>R_X86_64_PC32 这种重定位类型通常用于对全局符号进行重定位,以及在指令中引用数据段中的变量时进行重定位.</li></ul><ul><li>R_X86_64_PLT32 这种重定位类型通常用于对函数调用进行重定位.</li></ul><p>首先观察下图, 前文提到过为了生成可执行文件, 首先需要做的就是取出各个目标文件的 .text, .data , .bss 段并将其分别合并为一个大段, 然后拼接到一起得到一个文件, 也就是第一步. 可以看到最终得到的可执行文件已经确定了各个段的位置, 其中 <code>.text</code> 段的起始地址是 <code>0x401000</code>, <code>.data</code> 段的起始地址是 <code>0x404000</code>, 这两个地址比较重要, 因为我们稍后会需要用到它们, 这两个段的索引分别是 2 和 4</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516210929.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516210929.png" alt="20230516210929"></a></p><p>观察下图, 在合并对应的段之后每一个符号的位置也就确定了下来, 其中 swap 类型为 FUNC, 地址位于 <code>0x401040</code>, 位于 2 号段(也就是 .text 段). shared 类型为 OBJECT, 地址位于 <code>0x404000</code>(也就是 .data 段的首地址), 位于 4 号段(也就是.data段). 除此之外还可以看到 main 函数, 位于 <code>0x401000</code> 也就是 .text 段的首地址.</p><blockquote><p>不难推测, 对于其他变量和函数, 它们会在 .data 和 .text 段依次往后存放</p></blockquote><p>下图中也可以比较清晰的看到 main 和 swap 函数的地址起点, 就是顺序排列下来</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516211039.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516211039.png" alt="20230516211039"></a></p><p>那么接下来要做的事就是如何修改这里的四个字节以找到 shared 这个变量? 这里需要做一个计算, 当执行这条指令的时候, CPU 的 ip 的位置实际上是下一条指令的开始位置, 也就是箭头所示的位置 <code>0x40101e</code>, 我们已经得到了 shared 变量的地址是 <code>0x404000</code>, 所以只需要 0x404000 - 0x40101e = 0x2fe2, 小端存储也就是图中 <code>e2 2f 00 00</code></p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516231522.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230516231522.png" alt="20230516231522"></a></p><p><b>但是请注意</b>, <b>这里实际上跳过了一步</b>. 在这个阶段链接器并不能直接知道它的下一条指令的地址,也就是得不到 <code>0x40101e</code> 这个值. 我们目前看到的这个值是 objdump 帮助我们反汇编显示出来的每一行代表一句汇编, 实际上这就是一坨二进制数据. 这个值的计算依赖于重定位的 offset 和 addend 计算得到, 也就是说</p><p>ADDR(shared) - (ADDR(.text) + OFFSET(shared)) + ADDEND(shared)</p><p>0x404000 - (0x401000 + 0x1a) + (-4) = 0x404000 - 0x40101e = 0x2fe2</p><p>那么接下来的过程也是同理, 需要修正 swap 的函数跳转地址, 0x401040 - 0x401029 = 0x17</p><blockquote><p>这里的 0x401029 也是通过 (.text 段地址 + 偏移量 - addend) = 0x401000 + 0x25 - (-4) 计算得到的</p></blockquote><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20230517004015.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230517004015.png" alt="20230517004015"></a></p><h2 id="h2-6">静态库链接</h2><p>我们可以使用如下的命令找到 Linux 下的 libc 库</p><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">find</span><span class="Token SPACE"> </span><span class="Token PATH">/usr/lib</span><span class="Token MUL">*</span><span class="Token SPACE"> </span><span class="Token OPTION">-name</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;libc.a&quot;</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/lib/x86_64-linux-gnu/libc.a</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/lib32/libc.a</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/libx32/libc.a</span><span class="Token LF">
</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Program ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~</span><span class="Token TAG">$</span><span class="Token SPACE"> </span><span class="Token Program ID">find</span><span class="Token SPACE"> </span><span class="Token PATH">/usr/lib</span><span class="Token MUL">*</span><span class="Token SPACE"> </span><span class="Token OPTION">-name</span><span class="Token SPACE"> </span><span class="Token String STRING">&quot;libc.so&quot;</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/lib/x86_64-linux-gnu/libc.so</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/lib32/libc.so</span><span class="Token LF">
</span><span class="Token Program PATH">/usr/libx32/libc.so</span></code></pre><ul><li>/usr/lib/x86_64-linux-gnu/libc.a: 这是针对64位x86架构的Linux系统的库文件.它包含了glibc库的所有符号,并且在链接时可以将所有的代码静态地链接到目标程序中.这个路径是Debian和Ubuntu系统上的默认位置.</li></ul><ul><li>/usr/lib32/libc.a: 这是针对32位x86架构的Linux系统的库文件.它包含了glibc库的所有符号,并且在链接时可以将所有的代码静态地链接到目标程序中.这个路径在一些Linux系统上,如Fedora和CentOS上是默认位置.</li></ul><ul><li>/usr/libx32/libc.a: 这是针对x32 ABI的64位x86架构的Linux系统的库文件.x32 ABI是一种特殊的ABI,它使用32位指针和64位寄存器,旨在提高64位计算机上32位应用程序的性能.这个路径在一些Linux系统上,如Debian和Ubuntu上是默认位置.</li></ul><p>这些库文件是静态链接库,因此它们可能会增加可执行文件的大小,并且在多个程序使用相同的库时可能会导致重复.因此,通常建议使用动态链接库,例如libglibc.so或libc.so,以减少可执行文件的大小并实现共享.</p><p>一个静态库可以简单的看作<b>一组目标文件的集合</b>, 即很多目标文件压缩打包后形成的一个文件, 通常人们使用 ar 压缩程序将这些目标文件压缩到一起, 并且对其进行编号和索引以便于查找和检索, 这样就得到了 libc.a 这个静态库的文件</p><p>可以使用 ar 来压缩/解压/查看一个 .a 静态库的信息</p><pre class="language-shell"><code><span class="Token Program ID">ar</span></code></pre></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../linux/目录" >linux</a><ul><li><a href="../../linux/目录" >目录</a></li></ul><ul><li><a href="../../linux/终端" >终端</a></li></ul></li></ul><ul><li><a href="../../libc/LD_PRELOAD" >libc</a><ul><li><a href="../../libc/LD_PRELOAD" >LD_PRELOAD</a></li></ul></li></ul><ul><li><a href="../../工具库/命令行参数解析" >工具库</a><ul><li><a href="../../工具库/命令行参数解析" >命令行参数解析</a></li></ul></li></ul><ul><li><a href="../../miniCRT/ELF文件格式" >miniCRT</a><ul><li><a href="../../miniCRT/ELF文件格式" >ELF文件格式</a></li></ul><ul><li><a href="../../miniCRT/ELF文件结构详解" >ELF文件结构详解</a></li></ul><ul><li><a href="../../miniCRT/符号表" >符号表</a></li></ul><ul><li><a href="../../miniCRT/静态链接" >静态链接</a></li></ul></li></ul><ul><li><a href="../../阅读资料/起始地址故事" >阅读资料</a><ul><li><a href="../../阅读资料/起始地址故事" >起始地址故事</a></li></ul><ul><li><a href="../../阅读资料/编译器与C++" >编译器与C++</a></li></ul><ul><li><a href="../../阅读资料/交叉编译" >交叉编译</a></li></ul><ul><li><a href="../../阅读资料/AUB" >AUB</a></li></ul><ul><li><a href="../../阅读资料/gettext" >gettext</a></li></ul><ul><li><a href="../../阅读资料/gcc参数" >gcc参数</a></li></ul><ul><li><a href="../../阅读资料/函数命名规则" >函数命名规则</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../miniCRT/符号表","../../阅读资料/起始地址故事","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>